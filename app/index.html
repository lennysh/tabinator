<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Updated Title -->
    <title>Tabinator</title>
    <!-- 1. Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. js-yaml library (still needed for server) -->
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    
    <style>
        body {
            background-color: #111827; 
            color: #f3f4f6;
        }
        /* Base styles can go here, but @apply rules must be in the block below */
    </style>
    
    <style type="text/tailwindcss">
        /* --- Modal styles moved here --- */
        .modal-backdrop {
            @apply fixed inset-0 bg-black bg-opacity-75 transition-opacity duration-300 ease-in-out;
        }
        .modal-content {
            @apply fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg transition-all duration-300 ease-in-out scale-95;
        }
        .modal-visible {
            @apply pointer-events-auto; /* Make visible modal interactive */
        }
        .modal-visible .modal-backdrop {
            @apply opacity-100;
        }
        .modal-visible .modal-content {
            @apply opacity-100 scale-100;
        }
        .modal-hidden {
            @apply pointer-events-none; /* Make hidden modal non-interactive */
        }
        .modal-hidden .modal-backdrop {
            @apply opacity-0;
        }
        .modal-hidden .modal-content {
            @apply opacity-0 scale-95;
        }
        /* --- End modal styles --- */

        .btn {
            @apply px-4 py-2 rounded-lg text-white font-semibold transition-all duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed;
        }
        .btn-blue {
            @apply bg-blue-600 hover:bg-blue-700 shadow-md;
        }
        .btn-green {
            @apply bg-green-600 hover:bg-green-700 shadow-md;
        }
        .btn-red {
            @apply bg-red-600 hover:bg-red-700 shadow-md;
        }
        .btn-gray {
            @apply bg-gray-600 hover:bg-gray-700;
        }
        .btn-link {
            @apply p-1 text-gray-400 hover:text-white;
        }

        body {
            @apply font-sans min-h-screen;
        }
        
        .tag-btn {
            @apply px-3 py-1 text-sm rounded-full cursor-pointer transition-all duration-150 ease-in-out;
        }
        .tag-btn-inactive {
            @apply bg-gray-700 text-gray-300 hover:bg-gray-600;
        }
        .tag-btn-active {
            @apply bg-indigo-600 text-white font-medium ring-2 ring-indigo-400 ring-offset-2 ring-offset-gray-900;
        }
        .tag-btn-active-tag {
             @apply bg-blue-600 text-white font-medium ring-2 ring-blue-400 ring-offset-2 ring-offset-gray-900;
        }
        .tag-btn-hidden {
            @apply hidden;
        }
        
        /* Styling for link items to show admin buttons */
        .link-item .link-content {
            @apply w-10/12;
        }
        .admin-buttons {
            @apply w-2/12 flex justify-end gap-2;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans min-h-screen">

    <!-- Modal for Add/Edit Link -->
    <!-- This starts with .modal-hidden, which now correctly has pointer-events-none -->
    <div id="link-modal" class="modal-hidden fixed inset-0 z-50 overflow-hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <h3 class="text-lg font-medium leading-6 text-white mb-4" id="modal-title">Add New Link</h3>
            <form id="link-form">
                <input type="hidden" id="original-url" />
                <div class="space-y-4">
                    <div>
                        <label for="link-name" class="block text-sm font-medium text-gray-300">Name</label>
                        <input type="text" id="link-name" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="link-url" class="block text-sm font-medium text-gray-300">URL</label>
                        <input type="url" id="link-url" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="link-tags" class="block text-sm font-medium text-gray-300">Tags (comma-separated)</label>
                        <input type="text" id="link-tags" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="modal-cancel-btn" class="btn btn-gray">Cancel</button>
                    <button type="submit" id="modal-save-btn" class="btn btn-blue">Save</button>
                </div>
            </form>
        </div>
    </div>
    <!-- End Modal -->

    <div class="container max-w-7xl mx-auto p-4 md:p-8">
        
        <header class="mb-8">
            <div class="flex justify-between items-center mb-2">
                <!-- Updated Header -->
                <h1 class="text-4xl font-bold text-white">Tabinator</h1>
            </div>
            
            <p class="text-lg text-gray-400 mb-6">Your self-hosted tab dashboard.</p>
            
            <input
                type="search"
                id="search-bar"
                placeholder="Search titles, names, or URLs..."
                class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />

            <div class="mt-4 flex justify-between items-center gap-4">
                <div>
                    <label for="sort-select" class="block text-sm font-medium text-gray-400">Sort links by:</label>
                    <select id="sort-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base bg-gray-700 border-gray-600 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md text-white">
                        <option value="custom">Custom Order (default)</option>
                        <option value="az">A-Z (by name)</option>
                    </select>
                </div>
                <div class="admin-controls flex self-end">
                    <button id="show-add-modal-btn" class="btn btn-green">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block -mt-1 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        Add New Link
                    </button>
                </div>
            </div>
            
        </header>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
            
            <!-- Left Column for main content -->
            <div class="md:col-span-3">
                
                <div class="mb-8">
                    <button id="open-all-filtered-btn" class="btn btn-blue w-full">
                        Open All Filtered Links
                    </button>
                </div>
        
                <!-- MODIFIED: Added id="popup-warning" and default "hidden" class -->
                <div id="popup-warning" class="bg-yellow-800 border-l-4 border-yellow-500 text-yellow-100 p-4 rounded-lg mb-8 hidden" role="alert">
                    <p class="font-bold">Heads up!</p>
                    <p>Your browser's pop-up blocker will likely prevent the "Open All" button from working. Please **allow pop-ups** from this site for the feature to work correctly.</p>
                </div>
        
                <div id="loading-state" class="text-center text-gray-400 text-lg">
                    <p>Loading data from server...</p>
                </div>
        
                <div id="error-state" class="hidden bg-red-800 text-red-100 p-4 rounded-lg">
                    <p class="font-bold">Error loading config:</p>
                    <p id="error-message"></p>
                </div>
        
                <div id="no-results" class="hidden text-center text-gray-400 text-lg">
                    <p>No results found.</p>
                </div>
        
                <main id="app-container" class="hidden bg-gray-800 shadow-lg rounded-lg overflow-hidden">
                    <!-- Link list will be rendered here -->
                </main>

            </div>

            <!-- Right Column for Tag Sidebar -->
            <div class="md:col-span-1">
                <div class="sticky top-8 space-y-6">
                    <div id="group-filter-container" class="hidden bg-gray-800 rounded-lg p-4">
                        <label class="block text-sm font-medium text-gray-400 mb-3">Filter by Groups:</label>
                        <div id="group-pills-container" class="flex flex-wrap gap-2 max-h-[35vh] overflow-y-auto">
                            <!-- Group buttons will be dynamically inserted here -->
                        </div>
                    </div>
                    
                    <div id="tag-filter-container" class="hidden bg-gray-800 rounded-lg p-4">
                        <label class="block text-sm font-medium text-gray-400 mb-3">Filter by Tags:</label>
                        <div id="tag-pills-container" class="flex flex-wrap gap-2 max-h-[35vh] overflow-y-auto">
                            <!-- Tag buttons will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
            </div>

        </div> <!-- End 2-column grid -->

    </div>

    <script>
        // Store the parsed data globally
        let linkData = null; // Will hold { links: [], groups: [] }
        let currentlyFilteredLinks = [];
        
        // Store filter states globally
        let allTags = new Set();
        let activeTags = new Set();
        let allGroups = new Set(); // Will hold group *names*
        let activeGroups = new Set();
        
        let currentSort = 'custom';
        let currentQuery = '';
        
        let tagButtonElements = {};
        let groupButtonElements = {};

        // === NEW: API Helper ===
        /**
         * Generic helper for making API requests to the backend
         * @param {string} endpoint The API endpoint (e.g., '/api/links')
         * @param {string} method The HTTP method (GET, POST, PUT, DELETE)
         * @param {object} [body] The JSON data to send (for POST, PUT, DELETE)
         * @returns {Promise<object>} The JSON response from the server
         */
        async function apiRequest(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {},
            };

            if (body) {
                options.headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(endpoint, options);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Server error: ${response.status}`);
                }
                
                // For 201 (Created) or 200 (OK) with JSON response
                if (response.status === 201 || response.status === 200) {
                     // Handle 204 No Content for DELETE
                    if (response.headers.get("content-length") === "0") {
                        return { message: "Success" };
                    }
                    try {
                        return await response.json();
                    } catch (e) {
                        return { message: "Success, no JSON body."};
                    }
                }
                return { message: 'Operation successful.' }; // For other success codes like 204
            } catch (error) {
                console.error(`API request failed: ${method} ${endpoint}`, error);
                showGlobalError(error.message);
                throw error; // Re-throw to stop promise chain
            }
        }

        /**
         * Shows a global error message (e.g., for API failures)
         * @param {string} message The error message to display
         */
        function showGlobalError(message) {
            const errorEl = document.getElementById('error-state');
            const errorMsgEl = document.getElementById('error-message');
            errorMsgEl.textContent = message;
            errorEl.classList.remove('hidden');
            // Hide after 5 seconds
            setTimeout(() => {
                errorEl.classList.add('hidden');
            }, 5000);
        }

        // === NEW: Modal Controls ===
        const modal = document.getElementById('link-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const linkForm = document.getElementById('link-form');
        const formOriginalUrl = document.getElementById('original-url');
        const formName = document.getElementById('link-name');
        const formUrl = document.getElementById('link-url');
        const formTags = document.getElementById('link-tags');

        function showModal(title, link = null) {
            modalTitle.textContent = title;
            if (link) {
                // Edit mode
                formOriginalUrl.value = link.url;
                formName.value = link.name;
                formUrl.value = link.url;
                formTags.value = (link.tags || []).join(', ');
            } else {
                // Add mode
                linkForm.reset();
                formOriginalUrl.value = '';
            }
            modal.classList.remove('modal-hidden');
            modal.classList.add('modal-visible');
        }

        function hideModal() {
            modal.classList.add('modal-hidden');
            modal.classList.remove('modal-visible');
            linkForm.reset();
        }

        // === REMOVED Pop-up Checker ===
        // The check on page load was unreliable.
        // Logic is now inside handleOpenAllFiltered.
        
        // === Event Listeners ===
        document.addEventListener('DOMContentLoaded', () => {
            loadAndRenderLinks();
            // checkPopupBlocker(); // <-- REMOVED THIS CALL
            
            document.getElementById('open-all-filtered-btn').addEventListener('click', handleOpenAllFiltered);
            document.getElementById('tag-pills-container').addEventListener('click', handleTagClick);
            document.getElementById('group-pills-container').addEventListener('click', handleGroupClick);

            // Modal listeners
            document.getElementById('show-add-modal-btn').addEventListener('click', () => {
                showModal('Add New Link');
            });
            modalCancelBtn.addEventListener('click', hideModal);
            linkForm.addEventListener('submit', handleFormSubmit);

            // Listener for dynamic Edit/Delete buttons
            document.getElementById('app-container').addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-link-btn');
                if (deleteBtn) {
                    const url = deleteBtn.dataset.url;
                    // Use a simple confirm dialog for now.
                    // Note: This was in the original code, but for a real app, a custom modal is better.
                    if (window.confirm(`Are you sure you want to delete this link?\n${url}`)) {
                        handleDeleteLink(url);
                    }
                }

                const editBtn = e.target.closest('.edit-link-btn');
                if (editBtn) {
                    const url = editBtn.dataset.url;
                    const linkToEdit = linkData.links.find(l => l.url === url);
                    if (linkToEdit) {
                        showModal('Edit Link', linkToEdit);
                    }
                }
            });
        });

        /**
         * Fetches and parses the link data, then renders the app
         */
        async function loadAndRenderLinks() {
            const loadingEl = document.getElementById('loading-state');
            const errorEl = document.getElementById('error-state');
            const errorMsgEl = document.getElementById('error-message');
            const appEl = document.getElementById('app-container');

            const searchInput = document.getElementById('search-bar');
            const sortSelect = document.getElementById('sort-select');

            // Restore saved values from localStorage
            currentQuery = localStorage.getItem('tabinatorQuery') || '';
            currentSort = localStorage.getItem('tabinatorSort') || 'custom';
            activeTags = new Set(JSON.parse(localStorage.getItem('tabinatorTags') || '[]'));
            activeGroups = new Set(JSON.parse(localStorage.getItem('tabinatorGroups') || '[]'));

            // Apply restored values to inputs
            searchInput.value = currentQuery;
            sortSelect.value = currentSort;

            try {
                // 1. Fetch the data from the API
                linkData = await apiRequest('/api/data', 'GET');

                if (!linkData || !linkData.links) {
                    throw new Error("Data from server is valid but doesn't contain a 'links' list.");
                }
                // Ensure linkData.groups exists, even if empty
                if (!linkData.groups) {
                    linkData.groups = [];
                }

                // 3. Discover all tags and groups
                allTags.clear();
                allGroups.clear();
                linkData.links.forEach(link => {
                    link.tags?.forEach(tag => allTags.add(tag));
                });
                linkData.groups.forEach(group => {
                    if (group.name) {
                        allGroups.add(group.name);
                    }
                });
                
                // 4. Create tag and group pill elements ONCE
                createTagPills();
                createGroupPills();

                // 5. Render the application
                renderApp(); 

                // 6. Update UI state
                loadingEl.classList.add('hidden');
                appEl.classList.remove('hidden'); // This is now the <main> element

                // 7. Add event listeners
                searchInput.addEventListener('input', handleSearch);
                sortSelect.addEventListener('change', handleSort);

            } catch (error) {
                console.error("Error loading links:", error);
                errorMsgEl.textContent = error.message;
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
            }
        }
        
        /**
         * Creates all tag pill DOM elements one time on load
         */
        function createTagPills() {
            const tagContainer = document.getElementById('tag-pills-container');
            const tagFilterContainer = document.getElementById('tag-filter-container');
            tagContainer.innerHTML = '';
            tagButtonElements = {};
            
            if (allTags.size === 0) {
                tagFilterContainer.classList.add('hidden');
                return;
            }
            
            tagFilterContainer.classList.remove('hidden');
            const sortedTags = Array.from(allTags).sort((a, b) => a.localeCompare(b));
            
            sortedTags.forEach(tag => {
                const button = document.createElement('button');
                button.textContent = tag;
                button.setAttribute('data-tag', tag);
                tagContainer.appendChild(button);
                tagButtonElements[tag] = button;
            });
        }

        /**
         * Creates all group pill DOM elements one time on load
         */
        function createGroupPills() {
            const groupContainer = document.getElementById('group-pills-container');
            const groupFilterContainer = document.getElementById('group-filter-container');
            groupContainer.innerHTML = '';
            groupButtonElements = {};
            
            if (allGroups.size === 0) {
                groupFilterContainer.classList.add('hidden');
                return;
            }
            
            groupFilterContainer.classList.remove('hidden');
            // Sort by name from the allGroups Set
            const sortedGroups = Array.from(allGroups).sort((a, b) => a.localeCompare(b));
            
            sortedGroups.forEach(groupName => {
                const button = document.createElement('button');
                button.textContent = groupName;
                button.setAttribute('data-group', groupName);
                groupContainer.appendChild(button);
                groupButtonElements[groupName] = button;
            });
        }
        
        /**
         * Updates the visibility and state of tag pills based on filtered links
         */
        function updateTagPills(availableTags) {
             for (const tag in tagButtonElements) {
                const button = tagButtonElements[tag];
                const isActive = activeTags.has(tag);
                const isAvailable = availableTags.has(tag);

                if (isActive) {
                    button.className = 'tag-btn tag-btn-active-tag';
                } else if (isAvailable) {
                    button.className = 'tag-btn tag-btn-inactive';
                } else {
                    button.className = 'tag-btn tag-btn-hidden';
                }
            }
        }

        /**
         * Updates the visibility and state of group pills based on filtered links
         */
        function updateGroupPills(availableGroups) {
             for (const groupName in groupButtonElements) {
                const button = groupButtonElements[groupName];
                const isActive = activeGroups.has(groupName);
                const isAvailable = availableGroups.has(groupName);

                if (isActive) {
                    button.className = 'tag-btn tag-btn-active';
                } else if (isAvailable) {
                    button.className = 'tag-btn tag-btn-inactive';
                } else {
                    button.className = 'tag-btn tag-btn-hidden';
                }
            }
        }
        
        function checkList(list, linkProp, link) {
            if (!list || list.length === 0) return false; 

            if (linkProp === 'tags') {
                const linkTags = new Set(link.tags || []);
                return list.some(tag => linkTags.has(tag));
            } else {
                const linkValue = (link[linkProp] || '').toLowerCase();
                return list.some(keyword => linkValue.includes(keyword.toLowerCase()));
            }
        }

        function linkMatchesGroup(link, groupDef) {
            const includeBlocks = groupDef.include || [];
            const allIncludesMatch = includeBlocks.every(block => {
                return checkList(block.tags, 'tags', link) ||
                       checkList(block.names, 'name', link) ||
                       checkList(block.urls, 'url', link);
            });

            if (!allIncludesMatch) return false;

            const excludeBlocks = groupDef.exclude || [];
            const anyExcludeMatches = excludeBlocks.some(block => {
                return checkList(block.tags, 'tags', link) ||
                       checkList(block.names, 'name', link) ||
                       checkList(block.urls, 'url', link);
            });

            if (anyExcludeMatches) return false;
            
            return true;
        }

        /**
         * Renders the link groups and cards based on current filters
         */
        function renderApp() {
            if (!linkData || !linkData.links) return;

            const appEl = document.getElementById('app-container');
            const noResultsEl = document.getElementById('no-results');
            appEl.innerHTML = ''; // Clear previous content
            
            // 1. Filter by Search Query
            let searchFilteredLinks = [...linkData.links];
            if (currentQuery) {
                searchFilteredLinks = searchFilteredLinks.filter(link => {
                    const nameMatch = (link.name || '').toLowerCase().includes(currentQuery);
                    const urlMatch = (link.url || '').toLowerCase().includes(currentQuery);
                    return nameMatch || urlMatch;
                });
            }
            
            // 2. Filter by Active Tags (AND logic)
            let tagsFilteredLinks = [...searchFilteredLinks];
            if (activeTags.size > 0) {
                tagsFilteredLinks = tagsFilteredLinks.filter(link => {
                    if (!link.tags || !Array.isArray(link.tags)) return false;
                    return Array.from(activeTags).every(activeTag => link.tags.includes(activeTag));
                });
            }

            // 3. Filter by Active Groups (OR logic on definitions)
            let finalFilteredLinks = [...tagsFilteredLinks];
            if (activeGroups.size > 0) {
                const activeGroupDefs = linkData.groups.filter(g => activeGroups.has(g.name));
                
                finalFilteredLinks = tagsFilteredLinks.filter(link => {
                    return activeGroupDefs.some(groupDef => linkMatchesGroup(link, groupDef));
                });
            }
            
            // 4. Calculate available tags and groups
            const availableGroups = new Set();
            const allGroupDefs = linkData.groups || [];
            tagsFilteredLinks.forEach(link => {
                allGroupDefs.forEach(groupDef => {
                    if (availableGroups.has(groupDef.name)) return; 
                    if (linkMatchesGroup(link, groupDef)) {
                        availableGroups.add(groupDef.name);
                    }
                });
            });

            let groupsFilteredLinks = [...searchFilteredLinks];
            if (activeGroups.size > 0) {
                 const activeGroupDefs = linkData.groups.filter(g => activeGroups.has(g.name));
                 groupsFilteredLinks = searchFilteredLinks.filter(link => {
                    return activeGroupDefs.some(groupDef => linkMatchesGroup(link, groupDef));
                });
            }

            const availableTags = new Set();
            groupsFilteredLinks.forEach(link => {
                link.tags?.forEach(tag => availableTags.add(tag));
            });
            
            // 5. Update the tag and group pill UI
            updateTagPills(availableTags);
            updateGroupPills(availableGroups);

            // 6. Sort the filtered links
            let sortedLinks = [...finalFilteredLinks];
            if (currentSort === 'az') {
                sortedLinks.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            }
            
            // 7. Store the filtered links for the "Open All" button
            currentlyFilteredLinks = sortedLinks;
            
            // 8. Render the final list
            if (sortedLinks.length > 0) {
                renderLinkList(sortedLinks);
                noResultsEl.classList.add('hidden');
                appEl.classList.remove('hidden'); // Show the <main> element
            } else {
                noResultsEl.classList.remove('hidden');
                appEl.classList.add('hidden'); // Hide the <main> element
            }
            
            // 9. Update the "Open All" button text
            const openAllBtn = document.getElementById('open-all-filtered-btn');
            openAllBtn.textContent = `Open All Filtered Links (${currentlyFilteredLinks.length})`;
            openAllBtn.disabled = currentlyFilteredLinks.length === 0;
            if (openAllBtn.disabled) {
                openAllBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                openAllBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        
        /**
         * Renders the final list of links into the app container
         */
        function renderLinkList(links) {
            const appEl = document.getElementById('app-container');
            
            const getHostname = (url) => {
                try { return new URL(url).hostname; } catch (e) { return 'example.com'; }
            };
            
            const linksHtml = links.map(link => {
                
                let tagsHtml = '';
                if (link.tags && Array.isArray(link.tags)) {
                    const sortedLinkTags = [...link.tags].sort((a, b) => a.localeCompare(b));
                    tagsHtml = sortedLinkTags.map(tag => 
                        `<span class="bg-gray-600 text-gray-300 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">${tag}</span>`
                    ).join('');
                }

                // URL-encode the link URL to safely use in data attributes
                const encodedUrl = CSS.escape(link.url);

                return `
                <li class="link-item flex items-center p-3 hover:bg-gray-700 transition-colors duration-150">
                    <img 
                        src="https://www.google.com/s2/favicons?domain=${getHostname(link.url)}&sz=32" 
                        alt="favicon" 
                        class="w-5 h-5 mr-3 rounded-sm flex-shrink-0"
                        onerror="this.style.display='none'"
                    >
                    <div class="link-content flex-1 truncate min-w-0">
                        <a href="${link.url}" target="_blank" rel="noopener noreferrer" 
                           class="text-blue-400 hover:text-blue-300 text-base truncate block" 
                           title="${link.name}">
                            ${link.name || 'Missing Name'}
                        </a>
                        <p class="text-gray-400 text-xs truncate" title="${link.url}">
                            ${link.url || 'Missing URL'}
                        </p>
                        <div class="mt-2 flex flex-wrap gap-1 ${tagsHtml ? '' : 'hidden'}">
                            ${tagsHtml}
                        </div>
                    </div>
                    <!-- Admin Buttons -->
                    <div class="admin-buttons ml-auto">
                        <button class="edit-link-btn btn-link" data-url="${link.url}" title="Edit Link">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        </button>
                        <button class="delete-link-btn btn-link text-red-400 hover:text-red-300" data-url="${link.url}" title="Delete Link">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </li>
                `;
            }).join('');
            
            appEl.innerHTML = `<ul class="divide-y divide-gray-700">${linksHtml}</ul>`;
        }

        /**
         * Handles search input by re-rendering the app
         */
        function handleSearch(event) {
            currentQuery = event.target.value.toLowerCase();
            localStorage.setItem('tabinatorQuery', currentQuery);
            renderApp();
        }

        /**
         * Handles sort selection change by re-rendering the app
         */
        function handleSort(event) {
            currentSort = event.target.value;
            localStorage.setItem('tabinatorSort', currentSort);
            renderApp();
        }
        
        /**
         * Handles tag button clicks for filtering
         */
        function handleTagClick(event) {
            const target = event.target.closest('.tag-btn');
            if (!target) return;
            
            const tag = target.getAttribute('data-tag');
            if (activeTags.has(tag)) {
                activeTags.delete(tag);
            } else {
                activeTags.add(tag);
            }
            
            localStorage.setItem('tabinatorTags', JSON.stringify(Array.from(activeTags)));
            renderApp();
        }

        /**
         * Handles group button clicks for filtering
         */
        function handleGroupClick(event) {
            const target = event.target.closest('.tag-btn');
            if (!target) return;
            
            const group = target.getAttribute('data-group');
            if (activeGroups.has(group)) {
                activeGroups.delete(group);
            } else {
                activeGroups.add(group);
            }
            
            localStorage.setItem('tabinatorGroups', JSON.stringify(Array.from(activeGroups)));
            renderApp();
        }

        /**
         * Handles click on the main "Open All Filtered" button
         */
        function handleOpenAllFiltered() {
            const popupWarning = document.getElementById('popup-warning'); // Get warning element
            if (currentlyFilteredLinks && currentlyFilteredLinks.length > 0) {
                console.log(`Opening ${currentlyFilteredLinks.length} filtered links...`);
                let popupBlocked = false;
                
                currentlyFilteredLinks.forEach((link, i) => {
                    // Try to open a link
                    const newWindow = window.open(link.url, '_blank', 'noopener,noreferrer');
                    // Check if it failed (null, undefined, or blocked)
                    if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                        popupBlocked = true;
                    }
                });

                // After the loop, if any window failed, show the warning.
                if (popupBlocked) {
                    popupWarning.classList.remove('hidden');
                } else {
                    popupWarning.classList.add('hidden');
                }
            } else {
                console.warn('No filtered links to open.');
                popupWarning.classList.add('hidden'); // Also hide if no links
            }
        }

        // === NEW: CRUD Handlers ===

        /**
         * Handles the Add/Edit form submission
         */
        async function handleFormSubmit(e) {
            e.preventDefault();
            const originalUrl = formOriginalUrl.value;
            
            const link = {
                name: formName.value,
                url: formUrl.value,
                tags: formTags.value.split(',')
                                 .map(tag => tag.trim())
                                 .filter(tag => tag.length > 0)
            };
            
            // Disable button
            document.getElementById('modal-save-btn').disabled = true;

            try {
                if (originalUrl) {
                    // Edit Mode
                    await apiRequest('/api/links', 'PUT', { originalUrl, updatedLink: link });
                } else {
                    // Add Mode
                    await apiRequest('/api/links', 'POST', link);
                }
                
                hideModal();
                await loadAndRenderLinks(); // Reload all data from server
            } catch (error) {
                // Error is already shown by apiRequest helper
                console.error("Failed to save link:", error);
            } finally {
                // Re-enable button
                document.getElementById('modal-save-btn').disabled = false;
            }
        }

        /**
         * Handles deleting a link
         */
        async function handleDeleteLink(url) {
            try {
                await apiRequest('/api/links', 'DELETE', { url });
                await loadAndRenderLinks(); // Reload all data from server
            } catch (error) {
                console.error("Failed to delete link:", error);
            }
        }

    </script>
</body>
</html>

