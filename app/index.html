<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Updated Title -->
    <title>Tabinator</title>
    <!-- 1. Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. js-yaml library (still needed for server) -->
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    
    <style>
        body {
            background-color: #111827; 
            color: #f3f4f6;
        }
        /* Base styles can go here, but @apply rules must be in the block below */
    </style>
    
    <style type="text/tailwindcss">
        /* --- Modal styles moved here --- */
        .modal-backdrop {
            @apply fixed inset-0 bg-black bg-opacity-75 transition-opacity duration-300 ease-in-out;
        }
        .modal-content {
            @apply fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg transition-all duration-300 ease-in-out scale-95;
        }
        .modal-visible {
            @apply pointer-events-auto z-50; /* Make visible modal interactive */
        }
        .modal-visible .modal-backdrop {
            @apply opacity-100;
        }
        .modal-visible .modal-content {
            @apply opacity-100 scale-100;
        }
        .modal-hidden {
            @apply pointer-events-none; /* Make hidden modal non-interactive */
        }
        .modal-hidden .modal-backdrop {
            @apply opacity-0;
        }
        .modal-hidden .modal-content {
            @apply opacity-0 scale-95;
        }
        /* --- End modal styles --- */

        .btn {
            @apply px-4 py-2 rounded-lg text-white font-semibold transition-all duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed;
        }
        .btn-blue {
            @apply bg-blue-600 hover:bg-blue-700 shadow-md;
        }
        .btn-green {
            @apply bg-green-600 hover:bg-green-700 shadow-md;
        }
        .btn-red {
            @apply bg-red-600 hover:bg-red-700 shadow-md;
        }
        .btn-gray {
            @apply bg-gray-600 hover:bg-gray-700;
        }
        .btn-link {
            @apply p-1 text-gray-400 hover:text-white;
        }

        body {
            @apply font-sans min-h-screen;
        }
        
        .tag-btn {
            @apply px-3 py-1 text-sm rounded-full cursor-pointer transition-all duration-150 ease-in-out;
        }
        .tag-btn-inactive {
            @apply bg-gray-700 text-gray-300 hover:bg-gray-600;
        }
        .tag-btn-active {
            @apply bg-indigo-600 text-white font-medium ring-2 ring-indigo-400 ring-offset-2 ring-offset-gray-900;
        }
        .tag-btn-active-tag {
             @apply bg-blue-600 text-white font-medium ring-2 ring-blue-400 ring-offset-2 ring-offset-gray-900;
        }
        .tag-btn-hidden {
            @apply hidden;
        }
        
        /* Styling for link items to show admin buttons */
        .link-item .link-content {
            @apply w-10/12;
        }
        .admin-buttons {
            @apply w-2/12 flex justify-end gap-2;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans min-h-screen">

    <!-- Modal for Add/Edit Link -->
    <div id="link-modal" class="modal-hidden fixed inset-0 overflow-hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <h3 class="text-lg font-medium leading-6 text-white mb-4" id="modal-title">Add New Link</h3>
            <form id="link-form">
                <input type="hidden" id="original-url" />
                <div class="space-y-4">
                    <div>
                        <label for="link-name" class="block text-sm font-medium text-gray-300">Name</label>
                        <input type="text" id="link-name" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="link-url" class="block text-sm font-medium text-gray-300">URL</label>
                        <input type="url" id="link-url" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="link-tags" class="block text-sm font-medium text-gray-300">Tags (comma-separated)</label>
                        <input type="text" id="link-tags" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="modal-cancel-btn" class="btn btn-gray">Cancel</button>
                    <button type="submit" id="modal-save-btn" class="btn btn-blue">Save</button>
                </div>
            </form>
        </div>
    </div>
    <!-- End Modal -->

    <!-- NEW: Confirmation Modal -->
    <div id="confirm-modal" class="modal-hidden fixed inset-0 overflow-hidden" aria-labelledby="confirm-modal-title" role="dialog" aria-modal="true">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <h3 class="text-lg font-medium leading-6 text-white mb-4" id="confirm-modal-title">Are you sure?</h3>
            <div id="confirm-modal-body" class="text-gray-300 mb-6">
                <!-- Confirmation message will be injected here -->
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="confirm-modal-cancel-btn" class="btn btn-gray">Cancel</button>
                <button type="button" id="confirm-modal-ok-btn" class="btn btn-red">OK</button>
            </div>
        </div>
    </div>
    <!-- End Confirmation Modal -->

    <!-- Login Modal -->
    <div id="login-modal" class="modal-hidden fixed inset-0 overflow-hidden" aria-labelledby="login-modal-title" role="dialog" aria-modal="true">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <h3 class="text-lg font-medium leading-6 text-white mb-4" id="login-modal-title">Login</h3>
            <form id="login-form">
                <div class="space-y-4">
                    <div>
                        <label for="login-username" class="block text-sm font-medium text-gray-300">Username</label>
                        <input type="text" id="login-username" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-300">Password</label>
                        <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="login-error" class="hidden text-red-400 text-sm"></div>
                </div>
                <div class="mt-6 flex justify-between items-center">
                    <button type="button" id="show-register-btn" class="text-blue-400 hover:text-blue-300 text-sm">Need an account? Register</button>
                    <div class="flex gap-3">
                        <button type="button" id="login-cancel-btn" class="btn btn-gray">Cancel</button>
                        <button type="submit" id="login-submit-btn" class="btn btn-blue">Login</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <!-- End Login Modal -->

    <!-- Register Modal -->
    <div id="register-modal" class="modal-hidden fixed inset-0 overflow-hidden" aria-labelledby="register-modal-title" role="dialog" aria-modal="true">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <h3 class="text-lg font-medium leading-6 text-white mb-4" id="register-modal-title">Register</h3>
            <form id="register-form">
                <div class="space-y-4">
                    <div>
                        <label for="register-username" class="block text-sm font-medium text-gray-300">Username</label>
                        <input type="text" id="register-username" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <p class="mt-1 text-xs text-gray-400">3-50 characters, letters, numbers, underscores, and hyphens only</p>
                    </div>
                    <div>
                        <label for="register-email" class="block text-sm font-medium text-gray-300">Email</label>
                        <input type="email" id="register-email" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-gray-300">Password</label>
                        <input type="password" id="register-password" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <p class="mt-1 text-xs text-gray-400">At least 8 characters with uppercase, lowercase, and number</p>
                    </div>
                    <div id="register-error" class="hidden text-red-400 text-sm"></div>
                </div>
                <div class="mt-6 flex justify-between items-center">
                    <button type="button" id="show-login-btn" class="text-blue-400 hover:text-blue-300 text-sm">Already have an account? Login</button>
                    <div class="flex gap-3">
                        <button type="button" id="register-cancel-btn" class="btn btn-gray">Cancel</button>
                        <button type="submit" id="register-submit-btn" class="btn btn-green">Register</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <!-- End Register Modal -->

    <!-- Auth Status Bar -->
    <div id="auth-bar" class="hidden bg-gray-800 border-b border-gray-700 p-4">
        <div class="container max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <span class="text-gray-300">Logged in as: <strong id="auth-username" class="text-white"></strong></span>
            </div>
            <div class="flex gap-2">
                <button id="change-password-btn" class="btn btn-gray text-sm">Change Password</button>
                <button id="logout-btn" class="btn btn-gray text-sm">Logout</button>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="change-password-modal" class="modal-hidden fixed inset-0 overflow-hidden" aria-labelledby="change-password-modal-title" role="dialog" aria-modal="true">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <h3 class="text-lg font-medium leading-6 text-white mb-4" id="change-password-modal-title">Change Password</h3>
            <form id="change-password-form">
                <div class="space-y-4">
                    <div>
                        <label for="current-password" class="block text-sm font-medium text-gray-300">Current Password</label>
                        <input type="password" id="current-password" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="new-password" class="block text-sm font-medium text-gray-300">New Password</label>
                        <input type="password" id="new-password" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <p class="mt-1 text-xs text-gray-400">At least 8 characters with uppercase, lowercase, and number</p>
                    </div>
                    <div>
                        <label for="confirm-password" class="block text-sm font-medium text-gray-300">Confirm New Password</label>
                        <input type="password" id="confirm-password" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="change-password-error" class="hidden text-red-400 text-sm"></div>
                    <div id="change-password-success" class="hidden text-green-400 text-sm"></div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="change-password-cancel-btn" class="btn btn-gray">Cancel</button>
                    <button type="submit" id="change-password-submit-btn" class="btn btn-blue">Change Password</button>
                </div>
            </form>
        </div>
    </div>
    <!-- End Change Password Modal -->

    <!-- Groups Management Modal -->
    <div id="groups-modal" class="modal-hidden fixed inset-0 overflow-hidden" aria-labelledby="groups-modal-title" role="dialog" aria-modal="true">
        <div class="modal-backdrop"></div>
        <div class="modal-content" style="max-width: 90vw; width: 1200px; max-height: 90vh; overflow-y: auto;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium leading-6 text-white" id="groups-modal-title">Manage Groups</h3>
                <button id="groups-modal-close-btn" class="text-gray-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <div class="mb-4">
                <button id="add-group-btn" class="btn btn-green">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block -mt-1 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Add New Group
                </button>
            </div>

            <div id="groups-list" class="space-y-4">
                <!-- Groups will be rendered here -->
            </div>
        </div>
    </div>
    <!-- End Groups Management Modal -->

    <!-- Group Edit Modal -->
    <div id="group-edit-modal" class="modal-hidden fixed inset-0 overflow-hidden" aria-labelledby="group-edit-modal-title" role="dialog" aria-modal="true">
        <div class="modal-backdrop"></div>
        <div class="modal-content" style="max-width: 90vw; width: 800px; max-height: 90vh; overflow-y: auto;">
            <h3 class="text-lg font-medium leading-6 text-white mb-4" id="group-edit-modal-title">Edit Group</h3>
            <form id="group-edit-form">
                <input type="hidden" id="group-edit-id" />
                <div class="space-y-4">
                    <div>
                        <label for="group-edit-name" class="block text-sm font-medium text-gray-300">Group Name</label>
                        <input type="text" id="group-edit-name" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Include Rules</label>
                            <div id="group-edit-include" class="space-y-2">
                                <!-- Include blocks will be added here -->
                            </div>
                            <button type="button" id="add-include-block-btn" class="mt-2 btn btn-gray text-sm">+ Add Include Block</button>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Exclude Rules</label>
                            <div id="group-edit-exclude" class="space-y-2">
                                <!-- Exclude blocks will be added here -->
                            </div>
                            <button type="button" id="add-exclude-block-btn" class="mt-2 btn btn-gray text-sm">+ Add Exclude Block</button>
                        </div>
                    </div>
                    
                    <div id="group-edit-error" class="hidden text-red-400 text-sm"></div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="group-edit-cancel-btn" class="btn btn-gray">Cancel</button>
                    <button type="submit" id="group-edit-submit-btn" class="btn btn-blue">Save Group</button>
                </div>
            </form>
        </div>
    </div>
    <!-- End Group Edit Modal -->

    <!-- Main App Container (hidden until authenticated) -->
    <div id="app-wrapper" class="hidden">
    <div class="container max-w-7xl mx-auto p-4 md:p-8">
        
        <header class="mb-8">
            <div class="flex justify-between items-center mb-2">
                <!-- Updated Header -->
                <h1 class="text-4xl font-bold text-white">Tabinator</h1>
            </div>
            
            <p class="text-lg text-gray-400 mb-6">Your self-hosted tab dashboard.</p>
            
            <input
                type="search"
                id="search-bar"
                placeholder="Search titles, names, or URLs..."
                class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />

            <div class="mt-4 flex justify-between items-center gap-4">
                <div>
                    <label for="sort-select" class="block text-sm font-medium text-gray-400">Sort links by:</label>
                    <select id="sort-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base bg-gray-700 border-gray-600 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md text-white">
                        <option value="az">Name (A-Z)</option>
                        <option value="za">Name (Z-A)</option>
                        <option value="created-desc">Created (Newest First)</option>
                        <option value="created-asc">Created (Oldest First)</option>
                        <option value="updated-desc">Updated (Newest First)</option>
                        <option value="updated-asc">Updated (Oldest First)</option>
                    </select>
                </div>
                <div class="admin-controls flex self-end gap-2">
                    <button id="manage-groups-btn" class="btn btn-blue">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block -mt-1 mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z" /></svg>
                        Manage Groups
                    </button>
                    <button id="show-add-modal-btn" class="btn btn-green">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block -mt-1 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        Add New Link
                    </button>
                </div>
            </div>
            
        </header>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
            
            <!-- Left Column for main content -->
            <div class="md:col-span-3">
                
                <div class="mb-8">
                    <button id="open-all-filtered-btn" class="btn btn-blue w-full">
                        Open All Filtered Links
                    </button>
                </div>
        
                <!-- MODIFIED: Added id="popup-warning" and default "hidden" class -->
                <div id="popup-warning" class="bg-yellow-800 border-l-4 border-yellow-500 text-yellow-100 p-4 rounded-lg mb-8 hidden" role="alert">
                    <p class="font-bold">Heads up!</p>
                    <p>Your browser's pop-up blocker will likely prevent the "Open All" button from working. Please **allow pop-ups** from this site for the feature to work correctly.</p>
                </div>

                <!-- NEW: Warning for too many tabs -->
                <div id="tab-limit-warning" class="bg-red-800 border-l-4 border-red-500 text-red-100 p-4 rounded-lg mb-8 hidden" role="alert">
                    <p class="font-bold">Too Many Tabs</p>
                    <p id="tab-limit-message"></p>
                </div>
        
                <div id="loading-state" class="text-center text-gray-400 text-lg">
                    <p>Loading data from server...</p>
                </div>
        
                <div id="error-state" class="hidden bg-red-800 text-red-100 p-4 rounded-lg">
                    <p class="font-bold">Error loading config:</p>
                    <p id="error-message"></p>
                </div>
        
                <div id="no-results" class="hidden text-center text-gray-400 text-lg">
                    <p>No results found.</p>
                </div>
        
                <main id="app-container" class="hidden bg-gray-800 shadow-lg rounded-lg overflow-hidden">
                    <!-- Link list will be rendered here -->
                </main>

            </div>

            <!-- Right Column for Tag Sidebar -->
            <div class="md:col-span-1">
                <div class="sticky top-8 space-y-6">
                    <div id="group-filter-container" class="hidden bg-gray-800 rounded-lg p-4">
                        <label class="block text-sm font-medium text-gray-400 mb-3">Filter by Groups:</label>
                        <div id="group-pills-container" class="flex flex-wrap gap-2 max-h-[35vh] overflow-y-auto">
                            <!-- Group buttons will be dynamically inserted here -->
                        </div>
                    </div>
                    
                    <div id="tag-filter-container" class="hidden bg-gray-800 rounded-lg p-4">
                        <label class="block text-sm font-medium text-gray-400 mb-3">Filter by Tags:</label>
                        <div id="tag-pills-container" class="flex flex-wrap gap-2 max-h-[35vh] overflow-y-auto">
                            <!-- Tag buttons will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
            </div>

        </div> <!-- End 2-column grid -->

    </div>
    </div> <!-- End app-wrapper -->

    <script>
        // Store the parsed data globally
        let linkData = null; // Will hold { config: {}, links: [], groups: [] }
        let currentlyFilteredLinks = [];
        let maxTabsOpen = 20; // Default safety limit
        
        // Store filter states globally
        let allTags = new Set();
        let activeTags = new Set();
        let allGroups = new Set(); // Will hold group *names*
        let activeGroups = new Set();
        
        let currentSort = 'az';
        let currentQuery = '';
        
        let tagButtonElements = {};
        let groupButtonElements = {};

        // === Authentication State ===
        let isAuthenticated = false;
        let currentUser = null;

        // === API Helper ===
        /**
         * Generic helper for making API requests to the backend
         * @param {string} endpoint The API endpoint (e.g., '/api/links')
         * @param {string} method The HTTP method (GET, POST, PUT, DELETE)
         * @param {object} [body] The JSON data to send (for POST, PUT, DELETE)
         * @returns {Promise<object>} The JSON response from the server
         */
        async function apiRequest(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {},
                credentials: 'include' // Include cookies for session
            };

            if (body) {
                options.headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(endpoint, options);
                
                // Handle 401 Unauthorized
                if (response.status === 401) {
                    isAuthenticated = false;
                    showLoginModal();
                    throw new Error('Authentication required');
                }
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    // Handle validation errors with details
                    if (errorData.details && Array.isArray(errorData.details)) {
                        const errorMessages = errorData.details.map(d => d.msg || d.message).join(', ');
                        throw new Error(errorMessages || errorData.error || `Server error: ${response.status}`);
                    }
                    throw new Error(errorData.error || `Server error: ${response.status}`);
                }
                
                // For 201 (Created) or 200 (OK) with JSON response
                if (response.status === 201 || response.status === 200) {
                     // Handle 204 No Content for DELETE
                    if (response.headers.get("content-length") === "0") {
                        return { message: "Success" };
                    }
                    try {
                        return await response.json();
                    } catch (e) {
                        return { message: "Success, no JSON body."};
                    }
                }
                return { message: 'Operation successful.' }; // For other success codes like 204
            } catch (error) {
                console.error(`API request failed: ${method} ${endpoint}`, error);
                if (error.message !== 'Authentication required') {
                    showGlobalError(error.message);
                }
                throw error; // Re-throw to stop promise chain
            }
        }

        // === Authentication Functions ===
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/auth/me', { credentials: 'include' });
                const data = await response.json();
                
                if (data.authenticated) {
                    isAuthenticated = true;
                    currentUser = data.user;
                    showApp();
                    // Load data after authentication is confirmed
                    await loadAndRenderLinks();
                } else {
                    isAuthenticated = false;
                    showLoginModal();
                }
            } catch (error) {
                console.error('Error checking auth status:', error);
                isAuthenticated = false;
                showLoginModal();
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            const submitBtn = document.getElementById('login-submit-btn');

            errorEl.classList.add('hidden');
            submitBtn.disabled = true;

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    errorEl.textContent = data.error || 'Login failed';
                    errorEl.classList.remove('hidden');
                    return;
                }

                // Success
                isAuthenticated = true;
                currentUser = data.user;
                hideLoginModal();
                showApp();
                await loadAndRenderLinks();
            } catch (error) {
                errorEl.textContent = 'Network error. Please try again.';
                errorEl.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const errorEl = document.getElementById('register-error');
            const submitBtn = document.getElementById('register-submit-btn');

            errorEl.classList.add('hidden');
            submitBtn.disabled = true;

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username, email, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    const errorMsg = data.details ? data.details.map(d => d.msg).join(', ') : (data.error || 'Registration failed');
                    errorEl.textContent = errorMsg;
                    errorEl.classList.remove('hidden');
                    return;
                }

                // Success - auto login
                hideRegisterModal();
                document.getElementById('login-username').value = username;
                document.getElementById('login-password').value = password;
                await handleLogin({ preventDefault: () => {} });
            } catch (error) {
                errorEl.textContent = 'Network error. Please try again.';
                errorEl.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
            }
        }

        async function handleLogout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            isAuthenticated = false;
            currentUser = null;
            showLoginModal();
        }

        function showChangePasswordModal() {
            document.getElementById('change-password-modal').classList.remove('modal-hidden');
            document.getElementById('change-password-modal').classList.add('modal-visible');
            document.getElementById('change-password-form').reset();
            document.getElementById('change-password-error').classList.add('hidden');
            document.getElementById('change-password-success').classList.add('hidden');
        }

        function hideChangePasswordModal() {
            document.getElementById('change-password-modal').classList.add('modal-hidden');
            document.getElementById('change-password-modal').classList.remove('modal-visible');
        }

        async function handleChangePassword(event) {
            event.preventDefault();
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const errorEl = document.getElementById('change-password-error');
            const successEl = document.getElementById('change-password-success');
            const submitBtn = document.getElementById('change-password-submit-btn');

            errorEl.classList.add('hidden');
            successEl.classList.add('hidden');

            // Client-side validation
            if (newPassword !== confirmPassword) {
                errorEl.textContent = 'New passwords do not match';
                errorEl.classList.remove('hidden');
                return;
            }

            if (newPassword.length < 8) {
                errorEl.textContent = 'New password must be at least 8 characters';
                errorEl.classList.remove('hidden');
                return;
            }

            const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/;
            if (!passwordRegex.test(newPassword)) {
                errorEl.textContent = 'New password must contain at least one uppercase letter, one lowercase letter, and one number';
                errorEl.classList.remove('hidden');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Changing...';

            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ currentPassword, newPassword, confirmPassword })
                });

                const data = await response.json();

                if (!response.ok) {
                    const errorMsg = data.details ? data.details.map(d => d.msg).join(', ') : (data.error || 'Failed to change password');
                    errorEl.textContent = errorMsg;
                    errorEl.classList.remove('hidden');
                    return;
                }

                // Success
                successEl.textContent = 'Password changed successfully!';
                successEl.classList.remove('hidden');
                document.getElementById('change-password-form').reset();
                
                // Close modal after 2 seconds
                setTimeout(() => {
                    hideChangePasswordModal();
                }, 2000);
            } catch (error) {
                errorEl.textContent = 'Network error. Please try again.';
                errorEl.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Change Password';
            }
        }

        function showLoginModal() {
            document.getElementById('app-wrapper').classList.add('hidden');
            document.getElementById('auth-bar').classList.add('hidden');
            document.getElementById('login-modal').classList.remove('modal-hidden');
            document.getElementById('login-modal').classList.add('modal-visible');
        }

        function hideLoginModal() {
            document.getElementById('login-modal').classList.add('modal-hidden');
            document.getElementById('login-modal').classList.remove('modal-visible');
        }

        function showRegisterModal() {
            hideLoginModal();
            document.getElementById('register-modal').classList.remove('modal-hidden');
            document.getElementById('register-modal').classList.add('modal-visible');
        }

        function hideRegisterModal() {
            document.getElementById('register-modal').classList.add('modal-hidden');
            document.getElementById('register-modal').classList.remove('modal-visible');
        }

        function showApp() {
            document.getElementById('app-wrapper').classList.remove('hidden');
            document.getElementById('auth-bar').classList.remove('hidden');
            if (currentUser) {
                document.getElementById('auth-username').textContent = currentUser.username;
            }
            hideLoginModal();
            hideRegisterModal();
        }

        /**
         * Shows a global error message (e.g., for API failures)
         * @param {string} message The error message to display
         */
        function showGlobalError(message) {
            const errorEl = document.getElementById('error-state');
            const errorMsgEl = document.getElementById('error-message');
            errorMsgEl.textContent = message;
            errorEl.classList.remove('hidden');
            // Hide after 5 seconds
            setTimeout(() => {
                errorEl.classList.add('hidden');
            }, 5000);
        }

        // === Modal Controls ===
        const modal = document.getElementById('link-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const linkForm = document.getElementById('link-form');
        const formOriginalUrl = document.getElementById('original-url');
        const formName = document.getElementById('link-name');
        const formUrl = document.getElementById('link-url');
        const formTags = document.getElementById('link-tags');

        function showModal(title, link = null) {
            modalTitle.textContent = title;
            if (link) {
                // Edit mode
                formOriginalUrl.value = link.url;
                formName.value = link.name;
                formUrl.value = link.url;
                formTags.value = (link.tags || []).join(', ');
            } else {
                // Add mode
                linkForm.reset();
                formOriginalUrl.value = '';
            }
            modal.classList.remove('modal-hidden');
            modal.classList.add('modal-visible');
        }

        function hideModal() {
            modal.classList.add('modal-hidden');
            modal.classList.remove('modal-visible');
            linkForm.reset();
        }

        // --- NEW: Confirmation Modal Logic ---
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalBody = document.getElementById('confirm-modal-body');
        const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');
        const confirmModalOkBtn = document.getElementById('confirm-modal-ok-btn');

        /**
         * Shows a confirmation modal.
         * @param {string} title The title for the modal.
         * @param {string} bodyHTML The HTML content for the modal body.
         * @param {string} okButtonText The text for the confirmation button (e.g., "Delete").
         * @param {string} okButtonClass The Tailwind class for the OK button (e.g., "btn-red").
         * @returns {Promise<boolean>} A promise that resolves to true if OK was clicked, false if Cancel was.
         */
        function showConfirmation(title, bodyHTML, okButtonText = 'OK', okButtonClass = 'btn-red') {
            return new Promise((resolve) => {
                confirmModalTitle.textContent = title;
                confirmModalBody.innerHTML = bodyHTML;
                confirmModalOkBtn.textContent = okButtonText;
                
                // Reset OK button classes and apply new one
                confirmModalOkBtn.className = `btn ${okButtonClass}`;

                confirmModal.classList.remove('modal-hidden');
                confirmModal.classList.add('modal-visible');

                // Remove old listeners to prevent duplicates
                const newOkBtn = confirmModalOkBtn.cloneNode(true);
                confirmModalOkBtn.parentNode.replaceChild(newOkBtn, confirmModalOkBtn);
                
                const newCancelBtn = confirmModalCancelBtn.cloneNode(true);
                confirmModalCancelBtn.parentNode.replaceChild(newCancelBtn, confirmModalCancelBtn);

                // Add new listeners
                newOkBtn.addEventListener('click', () => {
                    hideConfirmation();
                    resolve(true);
                });

                newCancelBtn.addEventListener('click', () => {
                    hideConfirmation();
                    resolve(false);
                });
            });
        }

        function hideConfirmation() {
            confirmModal.classList.add('modal-hidden');
            confirmModal.classList.remove('modal-visible');
        }
        // --- End Confirmation Modal Logic ---
        
        // === Event Listeners ===
        document.addEventListener('DOMContentLoaded', () => {
            // Check authentication status first
            checkAuthStatus();

            // Auth modal listeners
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('login-cancel-btn').addEventListener('click', () => {
                if (!isAuthenticated) {
                    // Can't cancel if not authenticated
                    return;
                }
                hideLoginModal();
            });
            document.getElementById('register-cancel-btn').addEventListener('click', () => {
                hideRegisterModal();
                showLoginModal();
            });
            document.getElementById('show-register-btn').addEventListener('click', showRegisterModal);
            document.getElementById('show-login-btn').addEventListener('click', () => {
                hideRegisterModal();
                showLoginModal();
            });
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('change-password-btn').addEventListener('click', showChangePasswordModal);
            document.getElementById('change-password-form').addEventListener('submit', handleChangePassword);
            document.getElementById('change-password-cancel-btn').addEventListener('click', hideChangePasswordModal);
            
            // App listeners (only work when authenticated)
            document.getElementById('open-all-filtered-btn').addEventListener('click', handleOpenAllFiltered);
            document.getElementById('tag-pills-container').addEventListener('click', handleTagClick);
            document.getElementById('group-pills-container').addEventListener('click', handleGroupClick);

            // Modal listeners
            document.getElementById('show-add-modal-btn').addEventListener('click', () => {
                showModal('Add New Link');
            });
            modalCancelBtn.addEventListener('click', hideModal);
            linkForm.addEventListener('submit', handleFormSubmit);

            // Groups management listeners
            const manageGroupsBtn = document.getElementById('manage-groups-btn');
            const groupsModalCloseBtn = document.getElementById('groups-modal-close-btn');
            const addGroupBtn = document.getElementById('add-group-btn');
            const groupEditForm = document.getElementById('group-edit-form');
            const groupEditCancelBtn = document.getElementById('group-edit-cancel-btn');
            const addIncludeBlockBtn = document.getElementById('add-include-block-btn');
            const addExcludeBlockBtn = document.getElementById('add-exclude-block-btn');
            
            if (manageGroupsBtn) {
                manageGroupsBtn.addEventListener('click', showGroupsModal);
            }
            if (groupsModalCloseBtn) {
                groupsModalCloseBtn.addEventListener('click', hideGroupsModal);
            }
            if (addGroupBtn) {
                addGroupBtn.addEventListener('click', () => showGroupEditModal());
            }
            if (groupEditForm) {
                groupEditForm.addEventListener('submit', handleGroupFormSubmit);
            }
            if (groupEditCancelBtn) {
                groupEditCancelBtn.addEventListener('click', hideGroupEditModal);
            }
            if (addIncludeBlockBtn) {
                addIncludeBlockBtn.addEventListener('click', () => addGroupRuleBlock('group-edit-include'));
            }
            if (addExcludeBlockBtn) {
                addExcludeBlockBtn.addEventListener('click', () => addGroupRuleBlock('group-edit-exclude'));
            }
            
            // Delegated listeners for groups list
            const groupsListContainer = document.getElementById('groups-list');
            if (groupsListContainer) {
                groupsListContainer.addEventListener('click', async (e) => {
                    const editBtn = e.target.closest('.edit-group-btn');
                    if (editBtn) {
                        const groupId = parseInt(editBtn.dataset.groupId);
                        // Fetch fresh group data from API
                        try {
                            const groups = await apiRequest('/api/groups', 'GET');
                            const group = groups.find(g => g.id === groupId);
                            if (group) {
                                showGroupEditModal(group);
                            } else {
                                showGlobalError('Group not found');
                            }
                        } catch (error) {
                            console.error('Error loading group:', error);
                            showGlobalError('Failed to load group');
                        }
                    }
                    
                    const deleteBtn = e.target.closest('.delete-group-btn');
                    if (deleteBtn) {
                        const groupId = parseInt(deleteBtn.dataset.groupId);
                        handleDeleteGroup(groupId);
                    }
                });
            }

            // Listener for dynamic Edit/Delete buttons
            document.getElementById('app-container').addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-link-btn');
                if (deleteBtn) {
                    const url = deleteBtn.dataset.url;
                    // REPLACED window.confirm
                    handleDeleteLink(url);
                }

                const editBtn = e.target.closest('.edit-link-btn');
                if (editBtn) {
                    const url = editBtn.dataset.url;
                    const linkToEdit = linkData.links.find(l => l.url === url);
                    if (linkToEdit) {
                        showModal('Edit Link', linkToEdit);
                    }
                }
            });
        });

        /**
         * Fetches and parses the link data, then renders the app
         */
        async function loadAndRenderLinks() {
            const loadingEl = document.getElementById('loading-state');
            const errorEl = document.getElementById('error-state');
            const errorMsgEl = document.getElementById('error-message');
            const appEl = document.getElementById('app-container');

            // Show loading state
            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            appEl.classList.add('hidden');

            const searchInput = document.getElementById('search-bar');
            const sortSelect = document.getElementById('sort-select');

            // Restore saved values from localStorage
            currentQuery = localStorage.getItem('tabinatorQuery') || '';
            const savedSort = localStorage.getItem('tabinatorSort');
            // Migrate 'custom' to 'az' (default)
            currentSort = savedSort === 'custom' ? 'az' : (savedSort || 'az');
            if (savedSort === 'custom') {
                localStorage.setItem('tabinatorSort', 'az');
            }
            activeTags = new Set(JSON.parse(localStorage.getItem('tabinatorTags') || '[]'));
            activeGroups = new Set(JSON.parse(localStorage.getItem('tabinatorGroups') || '[]'));

            // Apply restored values to inputs
            if (searchInput) searchInput.value = currentQuery;
            if (sortSelect) sortSelect.value = currentSort;

            try {
                // Check authentication first
                if (!isAuthenticated) {
                    // Try to check auth status
                    const authResponse = await fetch('/api/auth/me', { credentials: 'include' });
                    const authData = await authResponse.json();
                    if (!authData.authenticated) {
                        loadingEl.classList.add('hidden');
                        showLoginModal();
                        return;
                    }
                    isAuthenticated = true;
                    currentUser = authData.user;
                    showApp(); // Make sure app is shown if we just authenticated
                }

                // 1. Fetch the data from the API
                linkData = await apiRequest('/api/data', 'GET');

                if (!linkData || !linkData.links) {
                    throw new Error("Data from server is valid but doesn't contain a 'links' list.");
                }
                
                // --- NEW: Read config section ---
                if (linkData.config && linkData.config.max_tabs_open) {
                    maxTabsOpen = parseInt(linkData.config.max_tabs_open, 10) || 20;
                    console.log(`Max tabs open limit set to: ${maxTabsOpen}`);
                } else {
                    console.warn(`No 'config.max_tabs_open' found in links.yaml. Defaulting to ${maxTabsOpen}.`);
                }
                // --- End new section ---

                // Ensure linkData.groups exists, even if empty
                if (!linkData.groups) {
                    linkData.groups = [];
                }
                
                // 3. Discover all tags and groups
                allTags.clear();
                allGroups.clear();
                linkData.links.forEach(link => {
                    link.tags?.forEach(tag => allTags.add(tag));
                });
                linkData.groups.forEach(group => {
                    if (group.name) {
                        allGroups.add(group.name);
                    }
                });
                
                // 4. Create tag and group pill elements ONCE
                createTagPills();
                createGroupPills();

                // 5. Render the application
                renderApp(); 

                // 6. Update UI state
                loadingEl.classList.add('hidden'); // Hide loading
                errorEl.classList.add('hidden'); // Hide any previous errors
                appEl.classList.remove('hidden'); // Show the main content

                // 7. Add event listeners (use one-time flag to avoid duplicates)
                // Get fresh references after potential DOM updates
                const finalSearchInput = document.getElementById('search-bar');
                const finalSortSelect = document.getElementById('sort-select');
                
                // Remove existing listeners by cloning
                if (finalSearchInput) {
                    const newSearchInput = finalSearchInput.cloneNode(true);
                    finalSearchInput.parentNode.replaceChild(newSearchInput, finalSearchInput);
                    newSearchInput.value = currentQuery;
                    newSearchInput.addEventListener('input', handleSearch);
                }
                
                if (finalSortSelect) {
                    const newSortSelect = finalSortSelect.cloneNode(true);
                    finalSortSelect.parentNode.replaceChild(newSortSelect, finalSortSelect);
                    newSortSelect.value = currentSort;
                    newSortSelect.addEventListener('change', handleSort);
                }

            } catch (error) {
                console.error("Error loading links:", error);
                loadingEl.classList.add('hidden');
                errorMsgEl.textContent = error.message;
                errorEl.classList.remove('hidden');
                
                // If it's an auth error, show login modal
                if (error.message === 'Authentication required' || error.message.includes('401')) {
                    isAuthenticated = false;
                    showLoginModal();
                }
            }
        }
        
        /**
         * Creates all tag pill DOM elements one time on load
         */
        function createTagPills() {
            const tagContainer = document.getElementById('tag-pills-container');
            const tagFilterContainer = document.getElementById('tag-filter-container');
            tagContainer.innerHTML = '';
            tagButtonElements = {};
            
            if (allTags.size === 0) {
                tagFilterContainer.classList.add('hidden');
                return;
            }
            
            tagFilterContainer.classList.remove('hidden');
            const sortedTags = Array.from(allTags).sort((a, b) => a.localeCompare(b));
            
            sortedTags.forEach(tag => {
                const button = document.createElement('button');
                button.textContent = tag;
                button.setAttribute('data-tag', tag);
                tagContainer.appendChild(button);
                tagButtonElements[tag] = button;
            });
        }

        /**
         * Creates all group pill DOM elements one time on load
         */
        function createGroupPills() {
            const groupContainer = document.getElementById('group-pills-container');
            const groupFilterContainer = document.getElementById('group-filter-container');
            groupContainer.innerHTML = '';
            groupButtonElements = {};
            
            if (allGroups.size === 0) {
                groupFilterContainer.classList.add('hidden');
                return;
            }
            
            groupFilterContainer.classList.remove('hidden');
            // Sort by name from the allGroups Set
            const sortedGroups = Array.from(allGroups).sort((a, b) => a.localeCompare(b));
            
            sortedGroups.forEach(groupName => {
                const button = document.createElement('button');
                button.textContent = groupName;
                button.setAttribute('data-group', groupName);
                groupContainer.appendChild(button);
                groupButtonElements[groupName] = button;
            });
        }
        
        /**
         * Updates the visibility and state of tag pills based on filtered links
         */
        function updateTagPills(availableTags) {
             for (const tag in tagButtonElements) {
                const button = tagButtonElements[tag];
                const isActive = activeTags.has(tag);
                const isAvailable = availableTags.has(tag);

                if (isActive) {
                    button.className = 'tag-btn tag-btn-active-tag';
                } else if (isAvailable) {
                    button.className = 'tag-btn tag-btn-inactive';
                } else {
                    button.className = 'tag-btn tag-btn-hidden';
                }
            }
        }

        /**
         * Updates the visibility and state of group pills based on filtered links
         */
        function updateGroupPills(availableGroups) {
             for (const groupName in groupButtonElements) {
                const button = groupButtonElements[groupName];
                const isActive = activeGroups.has(groupName);
                const isAvailable = availableGroups.has(groupName);

                if (isActive) {
                    button.className = 'tag-btn tag-btn-active';
                } else if (isAvailable) {
                    button.className = 'tag-btn tag-btn-inactive';
                } else {
                    // Show all groups, even if they have no matches (grayed out style)
                    button.className = 'tag-btn tag-btn-inactive opacity-50';
                }
            }
        }
        
        function checkList(list, linkProp, link) {
            if (!list || list.length === 0) return false; 

            if (linkProp === 'tags') {
                const linkTags = new Set(link.tags || []);
                return list.some(tag => linkTags.has(tag));
            } else {
                const linkValue = (link[linkProp] || '').toLowerCase();
                return list.some(keyword => linkValue.includes(keyword.toLowerCase()));
            }
        }

        function linkMatchesGroup(link, groupDef) {
            const includeBlocks = groupDef.include || [];
            const excludeBlocks = groupDef.exclude || [];
            
            // If no include blocks and no exclude blocks, don't match anything
            if (includeBlocks.length === 0 && excludeBlocks.length === 0) {
                return false;
            }
            
            // Check exclude blocks first (if any exclude matches, link is excluded)
            if (excludeBlocks.length > 0) {
                const anyExcludeMatches = excludeBlocks.some(block => {
                    return checkList(block.tags, 'tags', link) ||
                           checkList(block.names, 'name', link) ||
                           checkList(block.urls, 'url', link);
                });
                
                if (anyExcludeMatches) return false;
            }
            
            // If there are include blocks, at least one must match (OR logic between blocks)
            if (includeBlocks.length > 0) {
                const anyIncludeMatches = includeBlocks.some(block => {
                    return checkList(block.tags, 'tags', link) ||
                           checkList(block.names, 'name', link) ||
                           checkList(block.urls, 'url', link);
                });
                
                if (!anyIncludeMatches) return false;
            }
            
            // If we get here:
            // - Either there are include blocks and at least one matched, OR there are no include blocks
            // - AND no exclude blocks matched (or there are no exclude blocks)
            return true;
        }

        /**
         * Renders the link groups and cards based on current filters
         */
        function renderApp() {
            if (!linkData || !linkData.links) return;

            const appEl = document.getElementById('app-container');
            const noResultsEl = document.getElementById('no-results');
            const tabLimitWarningEl = document.getElementById('tab-limit-warning');
            const tabLimitMessageEl = document.getElementById('tab-limit-message');
            appEl.innerHTML = ''; // Clear previous content
            
            // 1. Filter by Search Query
            let searchFilteredLinks = [...linkData.links];
            if (currentQuery) {
                searchFilteredLinks = searchFilteredLinks.filter(link => {
                    const nameMatch = (link.name || '').toLowerCase().includes(currentQuery);
                    const urlMatch = (link.url || '').toLowerCase().includes(currentQuery);
                    return nameMatch || urlMatch;
                });
            }
            
            // 2. Filter by Active Tags (AND logic)
            let tagsFilteredLinks = [...searchFilteredLinks];
            if (activeTags.size > 0) {
                tagsFilteredLinks = tagsFilteredLinks.filter(link => {
                    if (!link.tags || !Array.isArray(link.tags)) return false;
                    return Array.from(activeTags).every(activeTag => link.tags.includes(activeTag));
                });
            }

            // 3. Filter by Active Groups (OR logic on definitions)
            let finalFilteredLinks = [...tagsFilteredLinks];
            if (activeGroups.size > 0) {
                const activeGroupDefs = linkData.groups.filter(g => activeGroups.has(g.name));
                
                finalFilteredLinks = tagsFilteredLinks.filter(link => {
                    return activeGroupDefs.some(groupDef => linkMatchesGroup(link, groupDef));
                });
            }
            
            // 4. Calculate available groups from tag-filtered links
            const availableGroups = new Set();
            const allGroupDefs = linkData.groups || [];
            tagsFilteredLinks.forEach(link => {
                allGroupDefs.forEach(groupDef => {
                    if (availableGroups.has(groupDef.name)) return; 
                    if (linkMatchesGroup(link, groupDef)) {
                        availableGroups.add(groupDef.name);
                    }
                });
            });

            // 5. Calculate available tags
            // Available tags = tags that appear in links matching: search + groups + active tags
            // For each tag, check if it appears in links that match all current filters
            const availableTags = new Set();
            
            // Start with search-filtered links
            let baseForTags = [...searchFilteredLinks];
            
            // Apply group filtering if groups are active
            if (activeGroups.size > 0) {
                const activeGroupDefs = linkData.groups.filter(g => activeGroups.has(g.name));
                baseForTags = baseForTags.filter(link => {
                    return activeGroupDefs.some(groupDef => linkMatchesGroup(link, groupDef));
                });
            }
            
            // For each tag, check if it appears in links matching the current active tags
            // (or all links if no tags are active)
            for (const tag of allTags) {
                let linksToCheck = [...baseForTags];
                
                // If there are active tags, filter by them (excluding the tag we're checking)
                if (activeTags.size > 0) {
                    const otherActiveTags = Array.from(activeTags).filter(t => t !== tag);
                    if (otherActiveTags.length > 0) {
                        linksToCheck = linksToCheck.filter(link => {
                            if (!link.tags || !Array.isArray(link.tags)) return false;
                            return otherActiveTags.every(activeTag => link.tags.includes(activeTag));
                        });
                    }
                }
                
                // Check if this tag appears in any of the filtered links
                const tagAppears = linksToCheck.some(link => 
                    link.tags && Array.isArray(link.tags) && link.tags.includes(tag)
                );
                
                if (tagAppears) {
                    availableTags.add(tag);
                }
            }
            
            // 5. Auto-clear filters that result in zero matches
            // Use the availableTags and availableGroups we calculated to determine what to clear
            if (finalFilteredLinks.length === 0 && (activeTags.size > 0 || activeGroups.size > 0)) {
                let filtersCleared = false;
                
                // Remove tags that are no longer available (don't match any links)
                activeTags.forEach(tag => {
                    if (!availableTags.has(tag)) {
                        activeTags.delete(tag);
                        filtersCleared = true;
                    }
                });
                
                // Remove groups that are no longer available (don't match any links)
                activeGroups.forEach(groupName => {
                    if (!availableGroups.has(groupName)) {
                        activeGroups.delete(groupName);
                        filtersCleared = true;
                    }
                });
                
                // Save cleared filters to localStorage and re-render
                if (filtersCleared) {
                    localStorage.setItem('tabinatorTags', JSON.stringify(Array.from(activeTags)));
                    localStorage.setItem('tabinatorGroups', JSON.stringify(Array.from(activeGroups)));
                    
                    // Re-render with cleared filters
                    renderApp();
                    return; // Exit early since we're re-rendering
                }
            }

            // 6. Update the tag and group pill UI
            updateTagPills(availableTags);
            updateGroupPills(availableGroups);

            // 7. Sort the filtered links
            let sortedLinks = [...finalFilteredLinks];
            switch (currentSort) {
                case 'az':
                    // Name (A-Z)
                    sortedLinks.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                    break;
                case 'za':
                    // Name (Z-A)
                    sortedLinks.sort((a, b) => (b.name || '').localeCompare(a.name || ''));
                    break;
                case 'created-desc':
                    // Created (Newest First)
                    sortedLinks.sort((a, b) => {
                        const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
                        const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
                        return dateB - dateA;
                    });
                    break;
                case 'created-asc':
                    // Created (Oldest First)
                    sortedLinks.sort((a, b) => {
                        const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
                        const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
                        return dateA - dateB;
                    });
                    break;
                case 'updated-desc':
                    // Updated (Newest First)
                    sortedLinks.sort((a, b) => {
                        const dateA = a.updated_at ? new Date(a.updated_at).getTime() : 0;
                        const dateB = b.updated_at ? new Date(b.updated_at).getTime() : 0;
                        return dateB - dateA;
                    });
                    break;
                case 'updated-asc':
                    // Updated (Oldest First)
                    sortedLinks.sort((a, b) => {
                        const dateA = a.updated_at ? new Date(a.updated_at).getTime() : 0;
                        const dateB = b.updated_at ? new Date(b.updated_at).getTime() : 0;
                        return dateA - dateB;
                    });
                    break;
                default:
                    // Default to A-Z if unknown sort option
                    sortedLinks.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            }
            
            // 8. Store the filtered links for the "Open All" button
            currentlyFilteredLinks = sortedLinks;
            
            // 9. Render the final list
            if (sortedLinks.length > 0) {
                renderLinkList(sortedLinks);
                noResultsEl.classList.add('hidden');
                appEl.classList.remove('hidden'); // Show the <main> element
            } else {
                noResultsEl.classList.add('hidden');
                appEl.classList.add('hidden'); // Hide the <main> element
            }
            
            // 10. Update the "Open All" button text
            const openAllBtn = document.getElementById('open-all-filtered-btn');
            const linkCount = currentlyFilteredLinks.length;
            openAllBtn.textContent = `Open All Filtered Links (${linkCount})`;
            openAllBtn.disabled = linkCount === 0;

            // --- NEW: Show warning if filtered count is over the limit ---
            if (linkCount > maxTabsOpen) {
                tabLimitMessageEl.textContent = `The current filter matches ${linkCount} tabs, which is over your safety limit of ${maxTabsOpen}. The "Open All" button will ask for confirmation.`;
                tabLimitWarningEl.classList.remove('hidden');
                openAllBtn.classList.add('btn-red'); // Make button red as a warning
                openAllBtn.classList.remove('btn-blue');
            } else {
                tabLimitWarningEl.classList.add('hidden');
                openAllBtn.classList.remove('btn-red');
                openAllBtn.classList.add('btn-blue');
            }
            // --- End new section ---

            if (openAllBtn.disabled) {
                openAllBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                openAllBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        
        /**
         * Renders the final list of links into the app container
         */
        function renderLinkList(links) {
            const appEl = document.getElementById('app-container');
            
            const getHostname = (url) => {
                try { return new URL(url).hostname; } catch (e) { return 'example.com'; }
            };
            
            const linksHtml = links.map(link => {
                
                let tagsHtml = '';
                if (link.tags && Array.isArray(link.tags)) {
                    const sortedLinkTags = [...link.tags].sort((a, b) => a.localeCompare(b));
                    tagsHtml = sortedLinkTags.map(tag => 
                        `<span class="bg-gray-600 text-gray-300 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">${tag}</span>`
                    ).join('');
                }

                // URL-encode the link URL to safely use in data attributes
                const encodedUrl = CSS.escape(link.url);

                return `
                <li class="link-item flex items-center p-3 hover:bg-gray-700 transition-colors duration-150">
                    <img 
                        src="https://www.google.com/s2/favicons?domain=${getHostname(link.url)}&sz=32" 
                        alt="favicon" 
                        class="w-5 h-5 mr-3 rounded-sm flex-shrink-0"
                        onerror="this.style.display='none'"
                    >
                    <div class="link-content flex-1 truncate min-w-0">
                        <a href="${link.url}" target="_blank" rel="noopener noreferrer" 
                           class="text-blue-400 hover:text-blue-300 text-base truncate block" 
                           title="${link.name}">
                            ${link.name || 'Missing Name'}
                        </a>
                        <p class="text-gray-400 text-xs truncate" title="${link.url}">
                            ${link.url || 'Missing URL'}
                        </p>
                        <div class="mt-2 flex flex-wrap gap-1 ${tagsHtml ? '' : 'hidden'}">
                            ${tagsHtml}
                        </div>
                    </div>
                    <!-- Admin Buttons -->
                    <div class="admin-buttons ml-auto">
                        <button class="edit-link-btn btn-link" data-url="${link.url}" title="Edit Link">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        </button>
                        <button class="delete-link-btn btn-link text-red-400 hover:text-red-300" data-url="${link.url}" title="Delete Link">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </li>
                `;
            }).join('');
            
            appEl.innerHTML = `<ul class="divide-y divide-gray-700">${linksHtml}</ul>`;
        }

        /**
         * Handles search input by re-rendering the app
         */
        function handleSearch(event) {
            currentQuery = event.target.value.toLowerCase();
            localStorage.setItem('tabinatorQuery', currentQuery);
            renderApp();
        }

        /**
         * Handles sort selection change by re-rendering the app
         */
        function handleSort(event) {
            currentSort = event.target.value;
            localStorage.setItem('tabinatorSort', currentSort);
            renderApp();
        }
        
        /**
         * Handles tag button clicks for filtering
         */
        function handleTagClick(event) {
            const target = event.target.closest('.tag-btn');
            if (!target) return;
            
            const tag = target.getAttribute('data-tag');
            if (activeTags.has(tag)) {
                activeTags.delete(tag);
            } else {
                activeTags.add(tag);
            }
            
            localStorage.setItem('tabinatorTags', JSON.stringify(Array.from(activeTags)));
            renderApp();
        }

        /**
         * Handles group button clicks for filtering
         */
        function handleGroupClick(event) {
            const target = event.target.closest('.tag-btn');
            if (!target) return;
            
            const group = target.getAttribute('data-group');
            if (activeGroups.has(group)) {
                activeGroups.delete(group);
            } else {
                activeGroups.add(group);
            }
            
            localStorage.setItem('tabinatorGroups', JSON.stringify(Array.from(activeGroups)));
            renderApp();
        }

        /**
         * Handles click on the main "Open All Filtered" button
         */
        async function handleOpenAllFiltered() {
            const popupWarning = document.getElementById('popup-warning');
            const linkCount = currentlyFilteredLinks.length;

            if (linkCount === 0) {
                console.warn('No filtered links to open.');
                popupWarning.classList.add('hidden');
                return;
            }
            
            // --- NEW: Check against maxTabsOpen limit ---
            if (linkCount > maxTabsOpen) {
                const confirmationMessage = `This will attempt to open <strong>${linkCount} tabs</strong>, which is more than your safety limit of ${maxTabsOpen}.<br><br>Are you sure you want to continue?`;
                
                const confirmed = await showConfirmation(
                    'Too Many Tabs', 
                    confirmationMessage, 
                    'Open All', 
                    'btn-red'
                );

                if (!confirmed) {
                    console.log('User cancelled opening multiple tabs.');
                    return; // Stop execution if user clicks 'Cancel'
                }
            }
            // --- End new section ---

            console.log(`Opening ${linkCount} filtered links...`);
            let popupBlocked = false;
            
            currentlyFilteredLinks.forEach((link, i) => {
                const newWindow = window.open(link.url, '_blank', 'noopener,noreferrer');
                if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                    popupBlocked = true;
                }
            });

            if (popupBlocked) {
                popupWarning.classList.remove('hidden');
            } else {
                popupWarning.classList.add('hidden');
            }
        }

        // === CRUD Handlers ===

        /**
         * Handles the Add/Edit form submission
         */
        async function handleFormSubmit(e) {
            e.preventDefault();
            const originalUrl = formOriginalUrl.value;
            
            const link = {
                name: formName.value.trim(),
                url: formUrl.value.trim(),
                tags: formTags.value.split(',')
                                 .map(tag => tag.trim())
                                 .filter(tag => tag.length > 0)
            };
            
            // Basic client-side validation
            if (!link.name || link.name.length === 0) {
                showGlobalError('Name is required');
                return;
            }
            if (!link.url || link.url.length === 0) {
                showGlobalError('URL is required');
                return;
            }
            
            // Disable button
            const saveBtn = document.getElementById('modal-save-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                if (originalUrl) {
                    // Edit Mode
                    await apiRequest('/api/links', 'PUT', { originalUrl, updatedLink: link });
                } else {
                    // Add Mode
                    await apiRequest('/api/links', 'POST', link);
                }
                
                hideModal();
                await loadAndRenderLinks(); // Reload all data from server
            } catch (error) {
                // Error is already shown by apiRequest helper
                console.error("Failed to save link:", error);
                // Don't hide modal on error so user can fix it
            } finally {
                // Re-enable button
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save';
            }
        }

        /**
         * Handles deleting a link
         */
        async function handleDeleteLink(url) {
            // Find the link name for a better confirmation message
            const linkToDelete = linkData.links.find(l => l.url === url);
            const linkName = linkToDelete ? linkToDelete.name : url;

            const confirmed = await showConfirmation(
                'Delete Link?',
                `Are you sure you want to delete this link?<br><br><strong class="text-white">${linkName}</strong><br><span class="text-xs text-gray-400">${url}</span>`,
                'Delete',
                'btn-red'
            );

            if (!confirmed) {
                return;
            }

            try {
                await apiRequest('/api/links', 'DELETE', { url });
                await loadAndRenderLinks(); // Reload all data from server
            } catch (error) {
                console.error("Failed to delete link:", error);
            }
        }

        // === Groups Management ===
        let groupsList = [];

        async function loadGroups() {
            try {
                groupsList = await apiRequest('/api/groups', 'GET');
                renderGroupsList();
            } catch (error) {
                console.error('Error loading groups:', error);
                showGlobalError('Failed to load groups');
            }
        }

        function renderGroupsList() {
            const container = document.getElementById('groups-list');
            if (!container) return;

            if (groupsList.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8">No groups defined. Click "Add New Group" to create one.</p>';
                return;
            }

            container.innerHTML = groupsList.map(group => {
                const includeRules = formatGroupRules(group.include || []);
                const excludeRules = formatGroupRules(group.exclude || []);
                
                return `
                    <div class="bg-gray-700 rounded-lg p-4">
                        <div class="flex justify-between items-start mb-3">
                            <h4 class="text-lg font-semibold text-white">${group.name}</h4>
                            <div class="flex gap-2">
                                <button class="edit-group-btn btn-link" data-group-id="${group.id}" title="Edit Group">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                </button>
                                <button class="delete-group-btn btn-link text-red-400 hover:text-red-300" data-group-id="${group.id}" title="Delete Group">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <div class="text-gray-400 font-medium mb-1">Include:</div>
                                <div class="text-gray-300">${includeRules || '<span class="text-gray-500">None</span>'}</div>
                            </div>
                            <div>
                                <div class="text-gray-400 font-medium mb-1">Exclude:</div>
                                <div class="text-gray-300">${excludeRules || '<span class="text-gray-500">None</span>'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatGroupRules(rules) {
            if (!rules || rules.length === 0) return '';
            return rules.map(block => {
                const parts = [];
                if (block.tags && block.tags.length > 0) {
                    parts.push(`Tags: ${block.tags.join(', ')}`);
                }
                if (block.names && block.names.length > 0) {
                    parts.push(`Names: ${block.names.join(', ')}`);
                }
                if (block.urls && block.urls.length > 0) {
                    parts.push(`URLs: ${block.urls.join(', ')}`);
                }
                return parts.join('; ');
            }).join(' | ');
        }

        function showGroupsModal() {
            document.getElementById('groups-modal').classList.remove('modal-hidden');
            document.getElementById('groups-modal').classList.add('modal-visible');
            loadGroups();
        }

        function hideGroupsModal() {
            document.getElementById('groups-modal').classList.add('modal-hidden');
            document.getElementById('groups-modal').classList.remove('modal-visible');
        }

        function showGroupEditModal(group = null) {
            const modal = document.getElementById('group-edit-modal');
            const form = document.getElementById('group-edit-form');
            const errorEl = document.getElementById('group-edit-error');
            
            errorEl.classList.add('hidden');
            form.reset();
            
            if (group) {
                document.getElementById('group-edit-id').value = group.id;
                document.getElementById('group-edit-name').value = group.name;
                renderGroupRules('group-edit-include', group.include || []);
                renderGroupRules('group-edit-exclude', group.exclude || []);
                document.getElementById('group-edit-modal-title').textContent = 'Edit Group';
            } else {
                document.getElementById('group-edit-id').value = '';
                document.getElementById('group-edit-name').value = '';
                document.getElementById('group-edit-include').innerHTML = '';
                document.getElementById('group-edit-exclude').innerHTML = '';
                document.getElementById('group-edit-modal-title').textContent = 'Add New Group';
            }
            
            modal.classList.remove('modal-hidden');
            modal.classList.add('modal-visible');
        }

        function hideGroupEditModal() {
            document.getElementById('group-edit-modal').classList.add('modal-hidden');
            document.getElementById('group-edit-modal').classList.remove('modal-visible');
        }

        function renderGroupRules(containerId, rules) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (rules.length === 0) {
                return;
            }
            
            rules.forEach((block, blockIndex) => {
                const blockDiv = document.createElement('div');
                blockDiv.className = 'bg-gray-800 rounded p-3 border border-gray-600';
                blockDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs text-gray-400">Block ${blockIndex + 1}</span>
                        <button type="button" class="remove-block-btn text-red-400 hover:text-red-300 text-xs">Remove</button>
                    </div>
                    <div class="space-y-2">
                        <div>
                            <label class="text-xs text-gray-400">Tags (comma-separated):</label>
                            <input type="text" class="block-rule-tags mt-1 w-full px-2 py-1 bg-gray-700 border border-gray-600 rounded text-white text-sm" 
                                   value="${(block.tags || []).join(', ')}" placeholder="tag1, tag2">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400">Names (comma-separated):</label>
                            <input type="text" class="block-rule-names mt-1 w-full px-2 py-1 bg-gray-700 border border-gray-600 rounded text-white text-sm" 
                                   value="${(block.names || []).join(', ')}" placeholder="name1, name2">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400">URLs (comma-separated):</label>
                            <input type="text" class="block-rule-urls mt-1 w-full px-2 py-1 bg-gray-700 border border-gray-600 rounded text-white text-sm" 
                                   value="${(block.urls || []).join(', ')}" placeholder="url1, url2">
                        </div>
                    </div>
                `;
                
                blockDiv.querySelector('.remove-block-btn').addEventListener('click', () => {
                    blockDiv.remove();
                });
                
                container.appendChild(blockDiv);
            });
        }

        function addGroupRuleBlock(containerId) {
            const container = document.getElementById(containerId);
            const blockDiv = document.createElement('div');
            blockDiv.className = 'bg-gray-800 rounded p-3 border border-gray-600';
            blockDiv.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xs text-gray-400">New Block</span>
                    <button type="button" class="remove-block-btn text-red-400 hover:text-red-300 text-xs">Remove</button>
                </div>
                <div class="space-y-2">
                    <div>
                        <label class="text-xs text-gray-400">Tags (comma-separated):</label>
                        <input type="text" class="block-rule-tags mt-1 w-full px-2 py-1 bg-gray-700 border border-gray-600 rounded text-white text-sm" 
                               placeholder="tag1, tag2">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Names (comma-separated):</label>
                        <input type="text" class="block-rule-names mt-1 w-full px-2 py-1 bg-gray-700 border border-gray-600 rounded text-white text-sm" 
                               placeholder="name1, name2">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">URLs (comma-separated):</label>
                        <input type="text" class="block-rule-urls mt-1 w-full px-2 py-1 bg-gray-700 border border-gray-600 rounded text-white text-sm" 
                               placeholder="url1, url2">
                    </div>
                </div>
            `;
            
            blockDiv.querySelector('.remove-block-btn').addEventListener('click', () => {
                blockDiv.remove();
            });
            
            container.appendChild(blockDiv);
        }

        function collectGroupRules(containerId) {
            const container = document.getElementById(containerId);
            const blocks = container.querySelectorAll('.bg-gray-800');
            const rules = [];
            
            blocks.forEach(block => {
                const tagsInput = block.querySelector('.block-rule-tags').value.trim();
                const namesInput = block.querySelector('.block-rule-names').value.trim();
                const urlsInput = block.querySelector('.block-rule-urls').value.trim();
                
                const blockData = {};
                if (tagsInput) {
                    blockData.tags = tagsInput.split(',').map(t => t.trim()).filter(t => t);
                }
                if (namesInput) {
                    blockData.names = namesInput.split(',').map(n => n.trim()).filter(n => n);
                }
                if (urlsInput) {
                    blockData.urls = urlsInput.split(',').map(u => u.trim()).filter(u => u);
                }
                
                // Only add block if it has at least one rule
                if (Object.keys(blockData).length > 0) {
                    rules.push(blockData);
                }
            });
            
            return rules;
        }

        async function handleGroupFormSubmit(e) {
            e.preventDefault();
            const groupId = document.getElementById('group-edit-id').value;
            const name = document.getElementById('group-edit-name').value.trim();
            const errorEl = document.getElementById('group-edit-error');
            const submitBtn = document.getElementById('group-edit-submit-btn');
            
            errorEl.classList.add('hidden');
            
            if (!name) {
                errorEl.textContent = 'Group name is required';
                errorEl.classList.remove('hidden');
                return;
            }
            
            const include = collectGroupRules('group-edit-include');
            const exclude = collectGroupRules('group-edit-exclude');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            
            try {
                if (groupId) {
                    // Update
                    await apiRequest(`/api/groups/${groupId}`, 'PUT', { name, include, exclude });
                } else {
                    // Create
                    await apiRequest('/api/groups', 'POST', { name, include, exclude });
                }
                
                hideGroupEditModal();
                await loadGroups();
                await loadAndRenderLinks(); // Reload to update groups in main view
            } catch (error) {
                errorEl.textContent = error.message || 'Failed to save group';
                errorEl.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Group';
            }
        }

        async function handleDeleteGroup(groupId) {
            const group = groupsList.find(g => g.id == groupId);
            const groupName = group ? group.name : 'this group';
            
            const confirmed = await showConfirmation(
                'Delete Group?',
                `Are you sure you want to delete the group "<strong class="text-white">${groupName}</strong>"?<br><br>This action cannot be undone.`,
                'Delete',
                'btn-red'
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                await apiRequest(`/api/groups/${groupId}`, 'DELETE');
                await loadGroups();
                await loadAndRenderLinks(); // Reload to update groups in main view
            } catch (error) {
                console.error('Failed to delete group:', error);
                showGlobalError('Failed to delete group');
            }
        }


    </script>
</body>
</html>

