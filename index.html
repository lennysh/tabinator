<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Launcher</title>
    <!-- 1. Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. js-yaml library to parse the YAML file -->
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    
    <!-- 
      ******************************************************************
      * FIX: Added a plain CSS block for the dark mode background.
      * This ensures the dark mode loads immediately and reliably.
      ******************************************************************
    -->
    <style>
        body {
            /* This is Tailwind's gray-900 and gray-100 */
            background-color: #111827; 
            color: #f3f4f6;
        }
    </style>
    
    <!-- 
      ******************************************************************
      * FIX: Added type="text/tailwindcss" to the style tag.
      * This is required for the @apply directives to work.
      ******************************************************************
    -->
    <style type="text/tailwindcss">
        /* Simple transition for button hover */
        .btn {
            @apply px-4 py-2 rounded-lg text-white font-semibold transition-all duration-200 ease-in-out;
        }
        .btn-blue {
            @apply bg-blue-600 hover:bg-blue-700 shadow-md;
        }
        .btn-green {
            @apply bg-green-600 hover:bg-green-700 shadow-sm;
        }
        /* This class will be applied by the body tag for Tailwind */
        body {
            @apply font-sans min-h-screen;
        }
    </style>
</head>
<!-- 
  The classes here will be processed by the Tailwind CDN and override
  the default styles above, ensuring fonts etc. are applied.
-->
<body class="bg-gray-900 text-gray-100 font-sans min-h-screen">

    <div class="container max-w-4xl mx-auto p-4 md:p-8">
        
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">Link Launcher</h1>
            <p class="text-lg text-gray-400 mb-6">Your self-hosted link group dashboard.</p>
            
            <!-- 
              ******************************************************************
              * NEW: Search Bar
              ******************************************************************
            -->
            <input
                type="search"
                id="search-bar"
                placeholder="Search titles, names, or URLs..."
                class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
        </header>

        <!-- 
          ******************************************************************
          * IMPORTANT: POP-UP BLOCKER WARNING
          ******************************************************************
        -->
        <div class="bg-yellow-800 border-l-4 border-yellow-500 text-yellow-100 p-4 rounded-lg mb-8" role="alert">
            <p class="font-bold">Heads up!</p>
            <p>Your browser's pop-up blocker will likely prevent the "Open All" buttons from working. Please **allow pop-ups** from this site (`http://localhost:8080`) for the feature to work correctly.</p>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="text-center text-gray-400 text-lg">
            <p>Loading `links.yaml`...</p>
        </div>

        <!-- Error State -->
        <div id="error-state" class="hidden bg-red-800 text-red-100 p-4 rounded-lg">
            <p class="font-bold">Error loading config:</p>
            <p id="error-message"></p>
        </div>

        <!-- No Results State (for search) -->
        <div id="no-results" class="hidden text-center text-gray-400 text-lg">
            <p>No results found.</p>
        </div>

        <!-- 
          ******************************************************************
          * UPDATED: Changed grid to single-column (grid-cols-1)
          * and increased gap for a "list" feel instead of "cards".
          ******************************************************************
        -->
        <main id="app-container" class="hidden grid grid-cols-1 gap-8"></main>

    </div>

    <script>
        // Store the parsed data globally for button access
        let linkData = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadAndRenderLinks();
            
            // Listen for clicks on the main container for event delegation
            const appContainer = document.getElementById('app-container');
            appContainer.addEventListener('click', handleAppClick);
        });

        /**
         * Fetches and parses the links.yaml file, then renders the app
         */
        async function loadAndRenderLinks() {
            const loadingEl = document.getElementById('loading-state');
            const errorEl = document.getElementById('error-state');
            const errorMsgEl = document.getElementById('error-message');
            const appEl = document.getElementById('app-container');

            try {
                // 1. Fetch the YAML file
                const response = await fetch('links.yaml');
                if (!response.ok) {
                    throw new Error(`Failed to fetch links.yaml (Status: ${response.status})`);
                }
                const yamlText = await response.text();

                // 2. Parse the YAML
                // 'jsyaml' is available from the CDN script in the <head>
                linkData = jsyaml.load(yamlText);

                if (!linkData || !linkData.groups) {
                    throw new Error("YAML file is valid but doesn't contain a 'groups' list.");
                }

                // 3. Render the application
                renderApp(linkData.groups, ""); // Pass an empty query initially

                // 4. Update UI state
                loadingEl.classList.add('hidden');
                appEl.classList.remove('hidden');

                // 5. NEW: Add search event listener
                document.getElementById('search-bar').addEventListener('input', handleSearch);

            } catch (error) {
                console.error("Error loading links:", error);
                errorMsgEl.textContent = error.message;
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
            }
        }

        /**
         * Renders the link groups and cards into the DOM
         * @param {Array} groups - The array of groups from the YAML file
         * @param {string} query - The search query to filter by
         */
        function renderApp(groups, query = "") {
            const appEl = document.getElementById('app-container');
            const noResultsEl = document.getElementById('no-results');
            appEl.innerHTML = ''; // Clear previous content
            let hasVisibleCards = false;

            if (groups.length === 0) {
                appEl.innerHTML = `<p class="text-gray-400 col-span-2 text-center">No link groups found in 'links.yaml'.</p>`;
                return;
            }

            // A. If there is no query, render all groups with all links
            if (query === "") {
                groups.forEach((group, groupIndex) => {
                    renderGroupCard(group, groupIndex, group.links);
                });
                hasVisibleCards = (groups.length > 0);
            } 
            // B. If there IS a query, filter based on the new logic
            else {
                groups.forEach((group, groupIndex) => {
                    const titleMatch = group.title.toLowerCase().includes(query);
                    
                    if (titleMatch) {
                        // 1. Title matches: render card with ALL links
                        renderGroupCard(group, groupIndex, group.links);
                        hasVisibleCards = true;
                    } else {
                        // 2. Title doesn't match, check links
                        const matchingLinks = group.links.filter(link => 
                            link.name.toLowerCase().includes(query) || 
                            link.url.toLowerCase().includes(query)
                        );
                        
                        if (matchingLinks.length > 0) {
                            // 3. Links match: render card with ONLY matching links
                            renderGroupCard(group, groupIndex, matchingLinks);
                            hasVisibleCards = true;
                        }
                    }
                    // 4. No match: do nothing, card is not rendered
                });
            }

            // Show or hide the "No results" message
            noResultsEl.classList.toggle('hidden', hasVisibleCards);
        }
        
        /**
         * NEW: Creates a single group card and appends it to the DOM
         * @param {object} group - The group object
         * @param {number} groupIndex - The original index (for the 'Open All' button)
         * @param {Array} linksToShow - The specific array of links to render
         */
        function renderGroupCard(group, groupIndex, linksToShow) {
            const appEl = document.getElementById('app-container');
            
            // Create the group card
            const card = document.createElement('div');
            // MODIFIED: Removed padding from the card, will add to header
            card.className = 'bg-gray-800 shadow-lg rounded-lg flex flex-col link-group-card overflow-hidden'; 
            
            let linksHtml = '';
            if (linksToShow && linksToShow.length > 0) {
                
                // NEW: Utility to get hostname for favicon
                const getHostname = (url) => {
                    try {
                        return new URL(url).hostname;
                    } catch (e) {
                        return 'example.com'; // Fallback
                    }
                };
                
                // NEW: Use a simple div container for the list
                linksHtml = linksToShow.map(link => `
                    <li class="flex items-center p-3 hover:bg-gray-700 transition-colors duration-150">
                        <img 
                            src="https://www.google.com/s2/favicons?domain=${getHostname(link.url)}&sz=32" 
                            alt="favicon" 
                            class="w-5 h-5 mr-3 rounded-sm"
                            onerror="this.style.display='none'"
                        >
                        <div class="flex-1 truncate">
                            <a href="${link.url}" target="_blank" rel="noopener noreferrer" 
                               class="text-blue-400 hover:text-blue-300 text-base" 
                               title="${link.name}">
                                ${link.name}
                            </a>
                            <p class="text-gray-400 text-xs truncate" title="${link.url}">
                                ${link.url}
                            </p>
                        </div>
                    </li>
                `).join('');
                // NEW: Wrap in a <ul>
                linksHtml = `<ul class="divide-y divide-gray-700">${linksHtml}</ul>`;

            } else {
                // This case should only happen if a group has no links
                linksHtml = '<p class="text-gray-500 p-4">No links in this group.</p>';
            }

            card.innerHTML = `
                <div class="flex-grow">
                    <!-- NEW: Added padding to the header area -->
                    <div class="flex justify-between items-center p-4 border-b border-gray-700">
                        <h2 class="text-2xl font-bold text-white">${group.title}</h2>
                        <!-- NEW: Moved button to the header -->
                        <button class="btn btn-blue open-all-btn flex-shrink-0" data-group-index="${groupIndex}">
                            Open All
                        </button>
                    </div>
                    
                    <!-- This div will contain the link list -->
                    <div class="space-y-1">
                        ${linksHtml}
                    </div>
                </div>
                <!-- 
                  ******************************************************************
                  * REMOVED: Button was moved to the header
                  ******************************************************************
                -->
            `;
            
            appEl.appendChild(card);
        }


        /**
         * NEW: Handles search input by re-rendering the app
         */
        function handleSearch(event) {
            const query = event.target.value.toLowerCase();
            if (linkData && linkData.groups) {
                renderApp(linkData.groups, query);
            }
        }


        /**
         * Handles clicks within the app container (event delegation)
         */
        function handleAppClick(event) {
            // NEW: Updated to find the button anywhere in the card
            const target = event.target.closest('.open-all-btn');

            // Check if an "Open All" button was clicked
            if (target) {
                const groupIndex = target.getAttribute('data-group-index');
                
                if (linkData && linkData.groups[groupIndex]) {
                    const linksToOpen = linkData.groups[groupIndex].links;
                    
                    if (linksToOpen && linksToOpen.length > 0) {
                        console.log(`Opening ${linksToOpen.length} links for group '${linkData.groups[groupIndex].title}'...`);
                        linksToOpen.forEach((link, i) => {
                            // This will be blocked by pop-up blockers!
                            window.open(link.url, '_blank');
                        });
                    } else {
                        console.warn('No links to open in this group.');
                    }
                }
            }
        }

    </script>
</body>
</html>

