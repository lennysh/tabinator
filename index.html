<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>Link Launcher</title>
    <!-- 1. Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. js-yaml library to parse the YAML file -->
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    
    <style>
        body {
            /* This is Tailwind's gray-900 and gray-100 */
            background-color: #111827; 
            color: #f3f4f6;
        }
    </style>
    
    <style type="text/tailwindcss">
        /* NEW: Added button styles back */
        .btn {
            @apply px-4 py-2 rounded-lg text-white font-semibold transition-all duration-200 ease-in-out;
        }
        .btn-blue {
            @apply bg-blue-600 hover:bg-blue-700 shadow-md;
        }
        body {
            @apply font-sans min-h-screen;
        }
        
        /* Styles for the tag filter buttons */
        .tag-btn {
            @apply px-3 py-1 text-sm rounded-full cursor-pointer transition-all duration-150 ease-in-out;
        }
        .tag-btn-inactive {
            @apply bg-gray-700 text-gray-300 hover:bg-gray-600;
        }
        .tag-btn-active {
            @apply bg-blue-600 text-white font-medium ring-2 ring-blue-400 ring-offset-2 ring-offset-gray-900;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans min-h-screen">

    <div class="container max-w-4xl mx-auto p-4 md:p-8">
        
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">Link Launcher</h1>
            <p class="text-lg text-gray-400 mb-6">Your self-hosted link dashboard.</p>
            
            <input
                type="search"
                id="search-bar"
                placeholder="Search titles, names, or URLs..."
                class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />

            <div class="mt-4">
                <div>
                    <label for="sort-select" class="block text-sm font-medium text-gray-400">Sort links by:</label>
                    <select id="sort-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base bg-gray-700 border-gray-600 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md text-white">
                        <option value="custom">Custom Order (default)</option>
                        <option value="az">A-Z (by name)</option>
                    </select>
                </div>
            </div>
            
            <div id="tag-filter-container" class="mt-6 hidden">
                <label class="block text-sm font-medium text-gray-400 mb-2">Filter by Tags:</label>
                <div id="tag-pills-container" class="flex flex-wrap gap-2">
                    <!-- Tag buttons will be dynamically inserted here -->
                </div>
            </div>
            
            <!-- 
              ******************************************************************
              * NEW: "Open All Filtered" Button
              ******************************************************************
            -->
            <div class="mt-6">
                <button id="open-all-filtered-btn" class="btn btn-blue w-full">
                    Open All Filtered Links
                </button>
            </div>

        </header>

        <!-- 
          ******************************************************************
          * NEW: Pop-up blocker warning is back
          ******************************************************************
        -->
        <div class="bg-yellow-800 border-l-4 border-yellow-500 text-yellow-100 p-4 rounded-lg mb-8" role="alert">
            <p class="font-bold">Heads up!</p>
            <p>Your browser's pop-up blocker will likely prevent the "Open All" button from working. Please **allow pop-ups** from this site (`http://localhost:8080`) for the feature to work correctly.</p>
        </div>


        <!-- Loading State -->
        <div id="loading-state" class="text-center text-gray-400 text-lg">
            <p>Loading `links.yaml`...</p>
        </div>

        <!-- Error State -->
        <div id="error-state" class="hidden bg-red-800 text-red-100 p-4 rounded-lg">
            <p class="font-bold">Error loading config:</p>
            <p id="error-message"></p>
        </div>

        <!-- No Results State (for search) -->
        <div id="no-results" class="hidden text-center text-gray-400 text-lg">
            <p>No results found.</p>
        </div>

        <main id="app-container" class="hidden bg-gray-800 shadow-lg rounded-lg overflow-hidden">
            <!-- Link list will be rendered here -->
        </main>

    </div>

    <script>
        // Store the parsed data globally
        let linkData = null;
        // NEW: Store the currently visible links for the "Open All" button
        let currentlyFilteredLinks = [];
        
        // Store filter states globally
        let allTags = new Set();
        let activeTags = new Set();
        let currentSort = 'custom';
        let currentQuery = '';

        document.addEventListener('DOMContentLoaded', () => {
            loadAndRenderLinks();
            
            // NEW: Add click listener for the main "Open All" button
            document.getElementById('open-all-filtered-btn').addEventListener('click', handleOpenAllFiltered);
            
            const tagContainer = document.getElementById('tag-pills-container');
            tagContainer.addEventListener('click', handleTagClick);
        });

        /**
         * Fetches and parses the links.yaml file, then renders the app
         */
        async function loadAndRenderLinks() {
            const loadingEl = document.getElementById('loading-state');
            const errorEl = document.getElementById('error-state');
            const errorMsgEl = document.getElementById('error-message');
            const appEl = document.getElementById('app-container');

            const searchInput = document.getElementById('search-bar');
            const sortSelect = document.getElementById('sort-select');

            // Restore saved values from localStorage
            currentQuery = localStorage.getItem('linkLauncherQuery') || '';
            currentSort = localStorage.getItem('linkLauncherSort') || 'custom';
            activeTags = new Set(JSON.parse(localStorage.getItem('linkLauncherTags') || '[]'));

            // Apply restored values to inputs
            searchInput.value = currentQuery;
            sortSelect.value = currentSort;

            try {
                // 1. Fetch the YAML file with cache-busting
                const response = await fetch('links.yaml', {
                    cache: 'no-store',
                    headers: { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' }
                });
                if (!response.ok) {
                    throw new Error(`Failed to fetch links.yaml (Status: ${response.status})`);
                }
                const yamlText = await response.text();

                // 2. Parse the YAML
                linkData = jsyaml.load(yamlText);

                if (!linkData || !linkData.links) {
                    throw new Error("YAML file is valid but doesn't contain a 'links' list.");
                }

                // 3. Discover all tags
                allTags.clear();
                linkData.links.forEach(link => {
                    if (link.tags && Array.isArray(link.tags)) {
                        link.tags.forEach(tag => allTags.add(tag));
                    }
                });
                
                // 4. Render tags
                renderTagPills();

                // 5. Render the application
                renderApp(); 

                // 6. Update UI state
                loadingEl.classList.add('hidden');
                appEl.classList.remove('hidden');

                // 7. Add event listeners
                searchInput.addEventListener('input', handleSearch);
                sortSelect.addEventListener('change', handleSort);

            } catch (error) {
                console.error("Error loading links:", error);
                errorMsgEl.textContent = error.message;
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
            }
        }
        
        /**
         * Renders the tag filter buttons
         */
        function renderTagPills() {
            const tagContainer = document.getElementById('tag-pills-container');
            const tagFilterContainer = document.getElementById('tag-filter-container');
            tagContainer.innerHTML = ''; // Clear old tags
            
            if (allTags.size === 0) {
                tagFilterContainer.classList.add('hidden');
                return; // No tags to render
            }
            
            tagFilterContainer.classList.remove('hidden');
            
            const sortedTags = Array.from(allTags).sort((a, b) => a.localeCompare(b));
            
            sortedTags.forEach(tag => {
                const button = document.createElement('button');
                const isActive = activeTags.has(tag);
                button.className = `tag-btn ${isActive ? 'tag-btn-active' : 'tag-btn-inactive'}`;
                button.textContent = tag;
                button.setAttribute('data-tag', tag);
                tagContainer.appendChild(button);
            });
        }

        /**
         * Renders the link groups and cards based on current filters
         */
        function renderApp() {
            if (!linkData || !linkData.links) return;

            const appEl = document.getElementById('app-container');
            const noResultsEl = document.getElementById('no-results');
            appEl.innerHTML = ''; // Clear previous content
            
            // 1. Filter links based on search AND tags
            const matchingLinks = linkData.links.filter(link => {
                const nameMatch = link.name.toLowerCase().includes(currentQuery);
                const urlMatch = link.url.toLowerCase().includes(currentQuery);
                
                const searchMatch = (currentQuery === "") || nameMatch || urlMatch;
                if (!searchMatch) return false;
                
                if (activeTags.size > 0) {
                    if (!link.tags || !Array.isArray(link.tags)) {
                        return false; 
                    }
                    return Array.from(activeTags).every(activeTag => link.tags.includes(activeTag));
                }
                
                return true;
            });

            // 2. Sort the filtered links
            let sortedLinks = [...matchingLinks];
            if (currentSort === 'az') {
                sortedLinks.sort((a, b) => a.name.localeCompare(b.name));
            }
            
            // 3. NEW: Store the filtered links for the "Open All" button
            currentlyFilteredLinks = sortedLinks;
            
            // 4. Render the final list
            if (sortedLinks.length > 0) {
                renderLinkList(sortedLinks);
                noResultsEl.classList.add('hidden');
            } else {
                noResultsEl.classList.remove('hidden');
            }
            
            // 5. NEW: Update the "Open All" button text
            const openAllBtn = document.getElementById('open-all-filtered-btn');
            openAllBtn.textContent = `Open All Filtered Links (${currentlyFilteredLinks.length})`;
            openAllBtn.disabled = currentlyFilteredLinks.length === 0;
            if (openAllBtn.disabled) {
                openAllBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                openAllBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        
        /**
         * Renders the final list of links into the app container
         */
        function renderLinkList(links) {
            const appEl = document.getElementById('app-container');
            
            const getHostname = (url) => {
                try { return new URL(url).hostname; } catch (e) { return 'example.com'; }
            };
            
            const linksHtml = links.map(link => {
                let tagsHtml = '';
                if (link.tags && Array.isArray(link.tags)) {
                    tagsHtml = link.tags.map(tag => 
                        `<span class="bg-gray-600 text-gray-300 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">${tag}</span>`
                    ).join('');
                }

                return `
                <li class="flex items-center p-3 hover:bg-gray-700 transition-colors duration-150">
                    <img 
                        src="https://www.google.com/s2/favicons?domain=${getHostname(link.url)}&sz=32" 
                        alt="favicon" 
                        class="w-5 h-5 mr-3 rounded-sm flex-shrink-0"
                        onerror="this.style.display='none'"
                    >
                    <div class="flex-1 truncate min-w-0">
                        <a href="${link.url}" target="_blank" rel="noopener noreferrer" 
                           class="text-blue-400 hover:text-blue-300 text-base truncate block" 
                           title="${link.name}">
                            ${link.name}
                        </a>
                        <p class="text-gray-400 text-xs truncate" title="${link.url}">
                            ${link.url}
                        </p>
                        <div class="mt-2 flex flex-wrap gap-1 ${tagsHtml ? '' : 'hidden'}">
                            ${tagsHtml}
                        </div>
                    </div>
                </li>
                `;
            }).join('');
            
            appEl.innerHTML = `<ul class="divide-y divide-gray-700">${linksHtml}</ul>`;
        }

        /**
         * Handles search input by re-rendering the app
         */
        function handleSearch(event) {
            currentQuery = event.target.value.toLowerCase();
            localStorage.setItem('linkLauncherQuery', currentQuery);
            renderApp();
        }

        /**
         * Handles sort selection change by re-rendering the app
         */
        function handleSort(event) {
            currentSort = event.target.value;
            localStorage.setItem('linkLauncherSort', currentSort);
            renderApp();
        }
        
        /**
         * Handles tag button clicks for filtering
         */
        function handleTagClick(event) {
            const target = event.target.closest('.tag-btn');
            if (!target) return;
            
            const tag = target.getAttribute('data-tag');
            if (activeTags.has(tag)) {
                activeTags.delete(tag);
                target.classList.replace('tag-btn-active', 'tag-btn-inactive');
            } else {
                activeTags.add(tag);
                target.classList.replace('tag-btn-inactive', 'tag-btn-active');
            }
            
            localStorage.setItem('linkLauncherTags', JSON.stringify(Array.from(activeTags)));
            renderApp();
        }

        /**
         * NEW: Handles click on the main "Open All Filtered" button
         */
        function handleOpenAllFiltered() {
            if (currentlyFilteredLinks && currentlyFilteredLinks.length > 0) {
                console.log(`Opening ${currentlyFilteredLinks.length} filtered links...`);
                currentlyFilteredLinks.forEach((link, i) => {
                    window.open(link.url, '_blank');
                });
            } else {
                console.warn('No filtered links to open.');
            }
        }

    </script>
</body>
</html>

